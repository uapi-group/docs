[{"id":0,"href":"/docs/conferences/2023-02-04__fosdem-devroom/","title":"2023 02 04 Fosdem Devroom","section":"Conferences","content":"Image-Based Linux and Secure/Measured Boot Devroom @ FOSDEM 23# The UAPI group, a community for people with an interest in innovating how we build, deploy, run, and update modern security-focused Linux operating systems, will host a devroom at FOSDEM 2023. A \u0026ldquo;devroom\u0026rdquo; (a FOSDEM term) is a co-located mini-conference with its own separate track.\nFOSDEM is an annual free event for software developers to meet, share ideas and collaborate. It took place on February 4 and 5 at the ULB Solbosch Campus in Brussels, Belgium. Learn more at https://fosdem.org/2023/.\nTalks and recordings\nPlease find talk abstracts, slide decks, and recordings at the FOSDEM pages referenced below.\nDevroom kick-off talk: UKI? DDI?? Oh my!!! Luca Boccassi Introducing and decoding image-based Linux terminology and concepts DM-Verity Rootfs Protection Frank Rehberger Blockwise Hashtree Image-Based Linux and TPMs Lennart Poettering Measured Boot, Protecting Secrets and you Building initrds in a new way Zbigniew Jędrzejewski-Szmek Ultrablue Gabriel Kerneis User-friendly Lightweight TPM Remote Attestation over Bluetooth Converging image and package based OS updates Ludwig Nussel Ubuntu Core: a technical overview Valentin David openSUSE MicroOS design Ignaz Forster A functional read-only OS in an imperfect world MachineOS: a Trusted, SecureBoot Image-based Container OS Ryan Harper "},{"id":1,"href":"/docs/conferences/2023-02-05_fosdem-kernel-devroom/","title":"2023 02 05 Fosdem Kernel Devroom","section":"Conferences","content":"Kernel Devroom @ FOSDEM 23# We are pleased to announce the Call for Participation (CfP) for the FOSDEM 2023 Kernel Devroom.\nFOSDEM 2023 will be over the weekend of the 4th and 5th of February in Brussels, Belgium. FOSDEM is a free and non-commercial event organised by the community for the community. The goal is to provide free and open source software developers and communities a place to meet to:\nget in touch with other developers and projects; be informed about the latest developments in the free software world; be informed about the latest developments in the open source world; attend interesting talks and presentations on various topics by project leaders and committers; to promote the development and benefits of free software and open source solutions. Participation and attendance is totally free, though the organisers gratefully accept donations and sponsorship. Format# The Kernel Devroom will be running all day on Sunday, 5 February, starting at 9am and finishing at 5pm.\nWe’re looking for talk or demo proposals in one of the following 4 sizes:\n10 minutes (e.g., a short demo) 20 minutes (e.g., a project update) 30 minutes (e.g., introduction to a new technology or a deep dive on a complex feature) 40 minutes (e.g., a deep dive on a complex feature) In all cases, please allow for at least 5 minutes of questions (10min preferred for the 30min slots). In general, shorter content will be more likely to get approved as we want to cover a wide range of topics.\nProposals# Proposals should be sent through the FOSDEM scheduling system at: https://penta.fosdem.org/submission/FOSDEM23/ Note that if you submitted a proposal to FOSDEM in the past, you can and should re-use your existing account rather than register a new one. If you have no account yet please create a new one. Make sure to fill in your speaker bio.\nPlease select the \u0026ldquo;Kernel\u0026rdquo; as the track and ensure you include the following information when submitting a proposal:\nSection Field Notes Person Name(s) Your first, last and public names. Person Abstract A short bio. Person Photo Please provide a photo. Event Event Title This is the title of your talk - please be descriptive to encourage attendance. Event Abstract Short abstract of one or two paragraphs. Event Duration Please indicate the length of your talk; 10 min, 20 min, 30, or 40 min The CfP deadline is Saturday, 10 December 2022.\nTopics# The Kernel Devroom aims to cover a wide range of different topics so don\u0026rsquo;t be shy. The following list should just serve as an inspiration:\nFilesystems and Storage io_uring Tracing eBPF Fuzzing System Boot Security Virtualization Rust in the Linux Kernel Code of Conduct# We\u0026rsquo;d like to remind all speakers and attendees that all of the presentations and discussions in our devroom are held under the guidelines set in the FOSDEM Code of Conduct and we expect attendees, speakers, and volunteers to follow the CoC at all times.\nIf you submit a proposal and it is accepted, you will be required to confirm that you accept the FOSDEM CoC. If you have any questions about the CoC or wish to have one of the devroom organizers review your presentation slides or any other content for CoC compliance, please email us and we will do our best to assist you.\n"},{"id":2,"href":"/docs/conferences/2023-09-13__all-systems-go/","title":"2023 09 13 All Systems Go","section":"Conferences","content":"All Systems Go! 2023# All Systems Go! is a conference focused on foundational user-space Linux technologies. Its goal is to provide a gathering place for both contributors and users of projects that make up the foundation of modern Linux systems. The UAPI Group was well-represented with many speakers and related talks. Learn more at https://all-systems-go.io/\nTalks abstracts and slide decks# Please see each individual talk on the schedule.\nTalks recordings# Please find the full list of talks recordings on media.ccc.de.\n"},{"id":3,"href":"/docs/conferences/2024-02-04_fosdem-kernel-devroom/","title":"2024 02 04 Fosdem Kernel Devroom","section":"Conferences","content":"Kernel Devroom @ FOSDEM 24# We are pleased to announce the Call for Participation (CfP) for the FOSDEM 2024 Kernel Devroom.\nFOSDEM 2024 will be over the weekend of the 3rd and 4th of February in Brussels, Belgium. FOSDEM is a free and non-commercial event organised by the community for the community. The goal is to provide free and open source software developers and communities a place to meet to:\nget in touch with other developers and projects; be informed about the latest developments in the free software world; be informed about the latest developments in the open source world; attend interesting talks and presentations on various topics by project leaders and committers; to promote the development and benefits of free software and open source solutions. Participation and attendance is totally free, though the organisers gratefully accept donations and sponsorship. Format# The Kernel Devroom will be running an all day, exact day and time will be clarified in the near future..\nWe’re looking for talk or demo proposals in one of the following 4 sizes:\n10 minutes (e.g., a short demo) 20 minutes (e.g., a project update) 30 minutes (e.g., introduction to a new technology or a deep dive on a complex feature) 40 minutes (e.g., a deep dive on a complex feature) In all cases, please allow for at least 5 minutes of questions (10min preferred for the 30min slots). In general, shorter content will be more likely to get approved as we want to cover a wide range of topics.\nProposals# Proposals should be sent through the FOSDEM scheduling system at: https://pretalx.fosdem.org/fosdem-2024/cfp\nPlease select the \u0026ldquo;Kernel\u0026rdquo; as the track and ensure you include the following information when submitting a proposal:\nSection Field Notes Person Name(s) Your first, last and public names. Person Abstract A short bio. Person Photo Please provide a photo. Event Event Title This is the title of your talk - please be descriptive to encourage attendance. Event Abstract Short abstract of one or two paragraphs. Event Duration Please indicate the length of your talk; 10 min, 20 min, 30, or 40 min The CfP deadline is Sunday, 10 December 2023.\nTopics# The Kernel Devroom aims to cover a wide range of different topics so don\u0026rsquo;t be shy. The following list should just serve as an inspiration:\nFilesystems and Storage io_uring Tracing eBPF Fuzzing System Boot Security Virtualization Rust in the Linux Kernel Code of Conduct# We\u0026rsquo;d like to remind all speakers and attendees that all of the presentations and discussions in our devroom are held under the guidelines set in the FOSDEM Code of Conduct and we expect attendees, speakers, and volunteers to follow the CoC at all times.\nIf you submit a proposal and it is accepted, you will be required to confirm that you accept the FOSDEM CoC. If you have any questions about the CoC or wish to have one of the devroom organizers review your presentation slides or any other content for CoC compliance, please email us and we will do our best to assist you.\n"},{"id":4,"href":"/docs/conferences/2024-09-18__lpc-uapi-mc/","title":"2024 09 18 Lpc Uapi MC","section":"Conferences","content":"Kernel \u0026lt;-\u0026gt; Userspace/Init/System Management boundaries and APIs MicroConference @ LPC 24# We are pleased to announce the Call for Participation (CfP) for the LPC 2024 Kernel \u0026lt;-\u0026gt; Userspace/Init/System Management boundaries and APIs MicroConference.\nLPC 2024 will be held in Vienna, Austria, September 18th to 20th 2024.\nThe focus of this microconference will be on topics related to the APIs and interfaces sitting at the boundary between the kernel and init systems/system management layers, with a special attention directed towards current pain points and omissions.\nFor example, issues around the current way initrd are loaded and set up between the bootloader and the kernel as we move towards immutable systems, or the interfaces provided by the kernel around the mount or cgroup or pidfd APIs as consumed by systemd or other service managers, or the uevent interactions between the kernel and udev.\nTopics and Format# We expect submissions to be either open discussions or presentations that discuss new proposals/ideas, ongoing work, or problems we are/should be solving in this space. Submissions are recommended to be 20 or 40 minutes long. Please specify the format and the desired length of your submission.\nPlease allow for at least 5 minutes of questions (10min preferred for the 40min slots).\nProposals# Proposals should be sent through the LPC scheduling system at: https://lpc.events/event/18/abstracts/\nPlease select the \u0026ldquo;Kernel \u0026lt;-\u0026gt; Userspace/Init/System Management boundaries and APIs MC\u0026rdquo; as the track.\nThe CfP deadline is Friday, 5 July 2024.\nCode of Conduct# All of the presentations and discussions in our MC are held under the guidelines set in the LPC Anti-harassment policy and we expect attendees, speakers, and volunteers to follow these rules at all times.\n"},{"id":5,"href":"/docs/conferences/2024-09-25__all-systems-go/","title":"2024 09 25 All Systems Go","section":"Conferences","content":"All Systems Go! 2024# All Systems Go! is a conference focused on foundational user-space Linux technologies. Its goal is to provide a gathering place for both contributors and users of projects that make up the foundation of modern Linux systems. The UAPI Group was well-represented with many speakers and related talks. Learn more at https://all-systems-go.io/.\nTalk abstracts and slide decks# Please see each individual talk on the schedule.\nTalk recordings# Please find the full list of talks recordings on media.ccc.de.\n"},{"id":6,"href":"/docs/conferences/2025-02-01_fosdem-kernel-devroom/","title":"2025 02 01 Fosdem Kernel Devroom","section":"Conferences","content":"Kernel Devroom @ FOSDEM 25# We are pleased to announce the Call for Participation (CfP) for the FOSDEM 2025 Kernel Devroom.\nFOSDEM 2025 will be over the weekend of the 1st and 2nd of February in Brussels, Belgium. FOSDEM is a free and non-commercial event organised by the community for the community. The goal is to provide free and open source software developers and communities a place to meet to:\nget in touch with other developers and projects; be informed about the latest developments in the free software world; be informed about the latest developments in the open source world; attend interesting talks and presentations on various topics by project leaders and committers; to promote the development and benefits of free software and open source solutions. Participation and attendance is totally free, though the organisers gratefully accept donations and sponsorship. Format# The Kernel Devroom will be running an all day, exact day and time will be clarified in the near future..\nWe’re looking for talk or demo proposals in one of the following 4 sizes:\n10 minutes (e.g., a short demo) 20 minutes (e.g., a project update) 30 minutes (e.g., introduction to a new technology or a deep dive on a complex feature) 40 minutes (e.g., a deep dive on a complex feature) In all cases, please allow for at least 5 minutes of questions (10min preferred for the 30min slots). In general, shorter content will be more likely to get approved as we want to cover a wide range of topics.\nProposals# Proposals should be sent through the FOSDEM scheduling system at: https://pretalx.fosdem.org/fosdem-2025/cfp\nPlease select the \u0026ldquo;Kernel\u0026rdquo; as the track and ensure you include the following information when submitting a proposal:\nSection Field Notes Person Name(s) Your first, last and public names. Person Abstract A short bio. Person Photo Please provide a photo. Event Event Title This is the title of your talk - please be descriptive to encourage attendance. Event Abstract Short abstract of one or two paragraphs. Event Duration Please indicate the length of your talk; 10 min, 20 min, 30, or 40 min The CfP deadline is Saturday, 1 December 2024.\nTopics# The Kernel Devroom aims to cover a wide range of different topics so don\u0026rsquo;t be shy. The following list should just serve as an inspiration:\nFilesystems and Storage io_uring Tracing eBPF Fuzzing System Boot Security Virtualization Memory management Rust in the Linux Kernel Code of Conduct# We\u0026rsquo;d like to remind all speakers and attendees that all of the presentations and discussions in our devroom are held under the guidelines set in the FOSDEM Code of Conduct and we expect attendees, speakers, and volunteers to follow the CoC at all times.\nIf you submit a proposal and it is accepted, you will be required to confirm that you accept the FOSDEM CoC. If you have any questions about the CoC or wish to have one of the devroom organizers review your presentation slides or any other content for CoC compliance, please email us and we will do our best to assist you.\n"},{"id":7,"href":"/docs/conferences/2025-02-02__fosdem-devroom/","title":"2025 02 02 Fosdem Devroom","section":"Conferences","content":"Image-Based Linux and Boot Integrity Devroom @ FOSDEM 25# The UAPI group, a community for people with an interest in innovating how we build, deploy, run, and update modern security-focused Linux operating systems, will host a devroom at FOSDEM 2025. A \u0026ldquo;devroom\u0026rdquo; (a FOSDEM term) is a co-located mini-conference with its own separate track.\nFOSDEM is an annual free event for software developers to meet, share ideas and collaborate. It takes place on February 1 and 2 at the ULB Solbosch Campus in Brussels, Belgium. Learn more at https://fosdem.org/2025/.\nImage-Based Linux and Boot Integrity Devroom Sunday February 2, 9:00—13:00\nDrop in for talks on image-based Linux and secure / attestable systems,\nand for a chat with UAPI folks. The schedule will be available on the FOSDEM website.\nCall for Participation We are looking for your talk proposals!\nTalks are 20 minutes (+5 for questions), on-site.\nCfP deadline is Sunday, Dec 1, 2024. Topics include:\nImage-based Linux distributions: intro, concepts, updates, differences with other distros OS and kernel image formats Cross-distro specifications and standards (e.g.: https://uapi-group.org) Trustable boot, device attestation, TPM usage and tooling A/B update implementations Reproducible builds as well as topics related to the above.\nTo apply:\nGo to https://pretalx.fosdem.org/fosdem-2025/cfp and fill in the proposal form. If you don’t have an account yet, create one first. In the submission form, make sure to select\nTrack: “Image-Based Linux and Boot Integrity”\nSession type: Talk\nAdd an abstract to both describe and to promote your talk. Proposals will be accepted based on your abstract and speaker bio, please make sure both are in good shape!\n"},{"id":8,"href":"/docs/conferences/2025-09-30__all-systems-go/","title":"2025 09 30 All Systems Go","section":"Conferences","content":"All Systems Go! 2025# All Systems Go! is a conference focused on foundational user-space Linux technologies. Its goal is to provide a gathering place for both contributors and users of projects that make up the foundation of modern Linux systems. The UAPI Group was well-represented with many speakers and related talks. Learn more at https://all-systems-go.io/.\nTalk abstracts and slide decks# Please see each individual talk on the schedule.\nTalk recordings# Please find the full list of talks recordings on media.ccc.de.\n"},{"id":9,"href":"/docs/conferences/2026-01-31_fosdem-kernel-devroom/","title":"2026 01 31 Fosdem Kernel Devroom","section":"Conferences","content":"Kernel Devroom @ FOSDEM 26# We are pleased to announce the Call for Participation (CfP) for the FOSDEM 2026 Kernel Devroom.\nFOSDEM 2026 will be over the weekend of the 31st of January and 1st of February in Brussels, Belgium. FOSDEM is a free and non-commercial event organised by the community for the community. The goal is to provide free and open source software developers and communities a place to meet to:\nget in touch with other developers and projects; be informed about the latest developments in the free software world; be informed about the latest developments in the open source world; attend interesting talks and presentations on various topics by project leaders and committers; to promote the development and benefits of free software and open source solutions. Participation and attendance is totally free, though the organisers gratefully accept donations and sponsorship. Format# The Kernel Devroom will be running a whole day, exact day and time will be clarified in the near future..\nWe’re looking for talk or demo proposals in one of the following 4 sizes:\n10 minutes (e.g., a short demo) 20 minutes (e.g., a project update) 30 minutes (e.g., introduction to a new technology or a deep dive on a complex feature) 40 minutes (e.g., a deep dive on a complex feature) In all cases, please allow for at least 5 minutes of questions (10min preferred for the 30min slots). In general, shorter content will be more likely to get approved as we want to cover a wide range of topics.\nProposals# Proposals should be sent through the FOSDEM scheduling system at: https://pretalx.fosdem.org/fosdem-2026/cfp\nPlease select \u0026ldquo;Kernel\u0026rdquo; as the track and ensure you include the following information when submitting a proposal:\nSection Field Notes Person Name(s) Your first, last and public names. Person Abstract A short bio. Person Photo Please provide a photo. Event Event Title This is the title of your talk - please be descriptive to encourage attendance. Event Abstract Short abstract of one or two paragraphs. Event Duration Please indicate the length of your talk; 10 min, 20 min, 30, or 40 min The CfP deadline is Wednesday, 10 December 2025.\nTopics# The Kernel Devroom aims to cover a wide range of different topics so don\u0026rsquo;t be shy. The following list should just serve as an inspiration:\nFilesystems and Storage io_uring Tracing eBPF Fuzzing System Boot Security Virtualization Memory management Rust in the Linux Kernel Code of Conduct# We\u0026rsquo;d like to remind all speakers and attendees that all of the presentations and discussions in our devroom are held under the guidelines set in the FOSDEM Code of Conduct and we expect attendees, speakers, and volunteers to follow the CoC at all times.\nIf you submit a proposal and it is accepted, you will be required to confirm that you accept the FOSDEM CoC. If you have any questions about the CoC or wish to have one of the devroom organizers review your presentation slides or any other content for CoC compliance, please email us and we will do our best to assist you.\n"},{"id":10,"href":"/docs/minutes/2022-10-05__image-based-linux-summit/","title":"2022 10 05 Image Based Linux Summit","section":"Minutes","content":"Image-based Linux summit, 5th - 6th October 2022, Berlin# The first image-based Linux summit took place on the 5th and the 6th of October, 2022. It was conducted as a loosely structured BoF-style event. The following parties were present at the summit (in no particular order):\nDistros / Entities: Ubuntu Core, Debian, GNOME OS, Fedora CoreOS, Endless OS, Arch Linux, SUSE, Flatcar, Microsoft, Amazon, Meta Projects: systemd, image-builder/osbuild, mkosi, tpm2-software, System Transparency, buildstream, BTRFS, rpm-ostree Actionables and tasks# Action items listed here can be found as TODO #[x] in the full meeting minutes below, with [x] being the action item number.\nProvide feedback to the proposal for systemd-syscfg Propose spec for application configuration file search path order to evangelise to application builders. Extend xdg_base specification to specify order (first to last): /run , then /etc , then /usr/etc use /usr/share/factory for vendor defaults, apps should never look there Let users override the above, e.g. via env vars (e.g. add /usr/local/…) Extend UKI to support allow-list of kernel command line parameters, or env var-like file allow sd-stub to pick up new cmdline via files, make shim verify it (via MoK), and consume it Add support for UKI booting to Grub. E.g. Grub module that loads a UKI and jumps into the kernel. Grub already has PE parser 4a. TODO sd-boot: Support type 1 entry that references type 2 + own kernel command line options Missing mkosi features: make sysext, UKI builds fully reproducible. calculate the signature server side, rebuild locally and apply (to make sig optional in case of legacy / non-UEFI system) support iso9660 - tracked here, also see TODO 10 switch to systemd-repart for unprivileged image builds, tracked here SPDX manifest file TODO 17 Extend Discoverable Partitions Specification to add policy language to restrict what the initrd will load from the disk allow recovery partition GUID allow discovery subvolumes/inode (BTRFS) Add versioning of resources to sysext / UKI spec. Use RPM versioning format. Auto-detect versioned resources by means of version prefix in sub-directories: ./foo.a/ has image(s) for resource foo version a (with a following RPM versioning format) ./foo.b/ has image(s) for resource foo version b (Flatcar team) Add support for boot-complete.target to signal \u0026ldquo;healthy boot\u0026rdquo;. Flatcar uses non-standard update_engine.service for the same. Tracked in Flatcar #865 Systemd boot-complete.target: add optional timer that fails if target is not reached within timeout, triggering a reboot, in turn triggering a rollback. Support in systemd-repart for optionally removing outdated partitions to free up space. MBR iso9660 (will also address part of TODO 5) Systemd to provide / standardise on a common target that means, after this is reached, root fs has been resized/reparted/etc and it is fully writable and ready initrd-root-fs.target already exists for the initrd stage local-fs-pre.target ? or new target? https://github.com/systemd/systemd/pull/24680 Standardise UEFI environment for systemd-repart to trigger full / partial reset. Also define a systemd target to reboot into for factory reset (full or partial) for interactive / desktop systems to offer on a boot menu Add support to repart for full repartitioning (full factory reset) if the disk UUID was set to 0xFFFF… (similar to existing support for partition factory reset on UUID 00000…) To handle app config, add support to systemd-tempfiles for removing files in factory reset mode - tracked here Discoverable Partition Spec: add specifications for partition flags to indicate the partition\u0026rsquo;s purpose (e.g. boot, sysext, recovery, etc.) systemd-sysupdate would ignore recovery partitions and not consider these part of an A/B update scheme systemd-sysupdate, systemd boot: add protection against unwanted roll-back (downgrade attack) by use of TPM counters. Add support for secure boot SBAT csv of images embedded in UKI, add SBAT csv to verity signature in DDI discover part mkinitcpio already implements objcopy functions which could be reused systemd-sysupdate download helper to become ‘pluggable’, so casync or other can be used instead of the built-in downloader (http). Add SPDX/SBOM field in os-release that points to local file or URL TODO #17 Enhance either cryptsetup or systemd-cryptsetup to support Shamir Secret Sharing and combine multiple tokens/slots Meeting minutes# OS images and integrity# UKI (unified kernel image): a new kernel/initrd format\nlimited to 4GB to fit into EFI space Secure, immutable, all in a single file (easy to update) Baked-in initrd, cmdline, root credentials (signed list of TPM PCR 11 values, key that signs the list) simplified storage of OS secrets, like disk encryption keys, making updates less brittle Credentials stored in the ESP, together with the UKI, are also gathered and passed to the booted system wrapped in a PE file, signed for UEFI Secure Boot There is a Red Hat feature request to allow multiple kernel cmdline in a single UKI, bootloader generates menu based on that (eg: debug mode, safe mode, etc.) Lack of bootloader-passed, custom command line could create issues later. TODO #3 to fix this. Root fs: UKI cmdline can have verity roothash, credentials can extended that\nUKIs enable both secure boot and TPM based security, independently\nThe TPM-based story for UKIs gives stronger guarantees than just Secure Boot, by allowing to express/attach policies to specific kernes/UKIs.\ngrub lacks support for UKI. TODO #4 to fix that.\nwould limit future flexibility in UKIs though (e.g. custom logic) since Grub would then need to support that, too Initrd is generated via mkosi\nhttps://github.com/systemd/mkosi-initrd LPC presentation slides LPC presentation recording Layered initrd, signed/read-only/measured, built server-side and deployed and loaded on demand Base initrd in UKI works on most systems, is extendable via sysext (e.g. optional support for hardware) mkosi-initrd can build base and layers from packages only Some work is ongoing on dracut to support this, in a hybrid mode where it builds the initrd/extensions from dracut modules, but no dracut runtime logic on the running system Problem: size constraints for existing systems, that have to be supported Documentation on pre-calculated and signed PCR values:\nUnrendered measure manpage, updated quickly Rendered measure manpage, may be outdated Unrendered stub manpage, updated quickly Rendered stub manpage, may be outdated UKI might be proposed for Fedora 39\nSysext initrd extensions will be shipped in RPMs Sysext, UKI not fully reproducible, see TODO #5 Discoverable Partitions Specification\nPlease file PRs to extend the specification to systemd\u0026rsquo;s repository Input collected in Summit see TODO #6 DDI: Discoverable Disk Image, uses DPS and signed dm-verity. Inspired by Canonical\u0026rsquo;s Snaps, uses the same technique and builds on top of it. Distro-independent sysext images? Vision: Kubernetes project can publish their own Kubernetes sysext, runs well on all distros, is self-updating client side, so Kubernetes upstream can keep it up to date just by publishing new versions.\nCould be done by promoting building tools for Go/Rust static binaries. Flatcar has a lab / playground for this, for example for Docker. mkosi to build UKIs, DDIs etc.. python based\nconfigured via .ini plus drop-ins supports dm-verity, SecureBoot, Signatures, PCR measurement for building UKIs, DDIs, sysext, initrd, OS images (w/ split partition support for individual partition update images)\nProduces manifest file with list of packages that were installed (SBOM) Does not support SLSA Native support on OBS Open Build Service Some features missing like reproducible builds, iso9660, switching to systemd-repart, see TODO 5 WIP: unprivileged builds, but dracut still needs root (run nspawn in image), BTRFS too Fedora CoreOS uses a small VM to handle partitioning / fill partitions w/o privileges, circumventing the above rpm-ostree + coreos-assembler can build images (kind-of-images as you can put them into a container image / convert to something else), see https://github.com/coreos/rpm-ostree, https://github.com/coreos/coreos-assembler\nosbuild\nEndless: OSTree built with eos-ostree-builder - private repo, but deb-ostree-builder is similar – and GPT disk images with eos-image-builder\nKIWI https://github.com/OSInside/kiwi\nFlatcar uses custom python script inherited from CoreOS, always builds images from sources (Gentoo style)\nAdds SLSA provenance (sources fingerprints -\u0026gt; binaries fingerprints) to OS image during build. Need to standardize on a common target that means, after this is reached, root fs has been resized/reparted/etc and it is fully writable and ready - see TODO #11\nNovel Linux file system technology for immutable OS images (blobfs, …)\ncomposefs RPM-backed images, e.g. using btrfs reflinks (rpm2extents) or FUSE (repomount) Blobfs (Fuchsia) simple FS that only allows git-like object store. Add object, get hash back No Linux support No inodes/filenames/dentries/attributes/access modes/timestamps/directories verity-protected, de-duplicated by default, garbage collection Simple enough to be accessed from firmware too Would enable use of single partition instead of A/B, could be added to the bottom of GPT and grow at the front. Pool of images - DDIs/UKIs or anything else - available everywhere with implicit and automatic trust in that partition.\nHandling user configuration changes# systemd already supports /usr/share/factory/ and specifiers in tmpfiles.d to populate /etc/ from there\nOther projects (ostree, libeconf) populate from /usr/etc/\nSome other projects use a 3-way merge of configurations in /etc/\nPrevious version default config Previous version w/ user changes New version default config Merging of configurations? PAM as a negative example w/ single-line changes\nRed Hat works around this by abstracting PAM into features (coarse application support), Debian has a more fine-grained (but manual) merge tool. PAM future: serve a static configuration and provide an API for dynamic / user defined changes PAM is just one example, glibc\u0026rsquo;s nss-switch is another\nOSTree copies from /usr/etc/ to /etc/ at first boot\nOn update, new configs are copied, user changes remain untouched (== config merge in per-file granularity) OpenSUSE uses the libeconf project, and MicroOS uses BTRFS snapshots: when a new snapshot is created, chroot into it and run the rpm scriptlets, then makes it read-only. User modifications are done via OverlayFS and stored in /var, which is outside the snapshot.\nPrograms could forward-convert config via ExecStartPre that figures out config differences semantically\nsshd has ssh-keygen for example Not fully adopted on all distros for first boot generation needs buy-in of each project to ship such tool User management: Fedora has started moving away from /etc/passwd and /etc/group to systemd-sysusers\nsystemd project just published syscfg proposal, see TODO #1\nCore concept is that even for configuration, one can always trace any file back to its source in a cryptographically secure way Could systemd-syscfg look at configuration-release SYSCFG_LEVEL= and make sure it matches /usr/\u0026rsquo;s SYSCFG_LEVEL=, and find the right image, or refuse a wrong one? Add sliding window for version support, on top of `==`` systemd-repart will be able to build syscfg DDIs, should be multi-call (call as e.g. systemd-makesyscfg build config DDI) long term, systemd sysext aims to use /etc/ as immutable / service factory default stack of configuration images and /etc/local/ as local user modifications.\ndistinguish between verified, secure config and binaries make node state cryptographically deterministic and only deploy workloads if we can prove a node to run trusted binaries in a trusted configuration tie a specific configuration to a specific time window, which allows e.g. a secret to be unlocked only in a given week and not afterwards syscfg rollback: how to do it at system level?\nAt service level (ConfigurationImages=) it’s easier as there’s a single one that has a clear signal on reload At system level problem is combinatorial explosion, could try with counters - each config image has a counter, start with highest and count down Also needs rollback protection, idea: TPM2 monotonic counter establishes (sliding) range window of allowed versions TODO #2: establish spec for search path order, to at least try to push applications, extend xdg_base specification to specify order as (first to last). See details there.\n/run/ -\u0026gt; /etc/ -\u0026gt; /usr/etc/, /usr/share/factory/ for vendor mask, override, etc. OSTree uses /usr/etc/ and /etc/, prefers local (/etc/) files in case of conflicts\nenforces reboots after config changes Some distros address this at packaging level, push package maintainers to default to /usr/etc/\nUsrEtc on SUSE credential handling in /etc/: systemd-credentials can inject sensitive information into system services\nsecrets are encrypted using TPMs, and only decrypted on demand immediately before consumption meant as a replacement for passing creds in env variables exposes secrets as files Updating OS Images and overlays# Prior Art# Build/deploy: can we learn from OCI? Current OCI users use tarballs and merge them, no offline/online security OCI layers are linear and one way merge Fedora IoT / RHEL 4 Edge uses Greenboot During meeting Greenboot was nudged to use boot-complete SUSE has openSUSE Health-checker Ubuntu has a health check too GNOME OS nudge to use boot-complete Endless OS has rudimentary check, \u0026ldquo;did a user GNOME session start? If so, grub-editenv - unset recordfail\u0026rdquo;) Future Developments# systemd-repart: declarative configuration of system partitions, can populate systems with files too, cryptographically secure\nruns in initrd, \u0026ldquo;magic tar for creating system layout\u0026rdquo; can build images, too (DDI - Discoverable Disk Image) Supports GPT Some features missing, see TODO #10 Automatic boot assessment after update to mark partition/disk/whatever as good/bad\nSpecification Systemd provides boot-complete.target to signal \u0026ldquo;boot is healthy\u0026rdquo; TODO #8: Add support to Flatcar Already hooked up with sd-boot Make this target depend on health test / critical service units There is one test shipped by upstream that checks for no failed services, but is likely too broad as some services should be allowed to fail TODO #9: add optional timer that fails if nothing happens within time, triggering reboot / rollback General A/B booting, versioning# Prior Art# grub vs. sd-boot legacy hardware / non-EFI access to filesystems in grub shim only supports grub (signature) as bootloader for secure boot currently Issue could be mitigated if grub could boot UKIs Using partitions vs. putting fs images into writable space OS (initrd) would need to trust FS used for writable space but since space is writable, FS exploits can be staged there, tainting the FS OS, when booting, mounts tainted FS to get access to OS FS images stored there, and chain of trust is broken Chromebook/Android Work in progress for (rpm-)ostree based systems to establish trust in the partition content State of the \u0026ldquo;custom/partial\u0026rdquo; BLS support in Fedora Support for fallback in Shim/grub Pull request Used mostly for updating shim itself Non-EFI platforms? See TODO #4 Grub UKI support SteamOS EFI loader Uses a \u0026ldquo;A\u0026rdquo; or \u0026ldquo;B\u0026rdquo; partition labels RAUC Embedded updater, with A/B slots, integrates with many bootloaders/filesystems Future Developments# Concept: flag partition after booting, good/bad, fallback sd-boot adds counters to UKI filename, uses counters for ordering in the menu for default entry More generally, any resource (sysext or UKI) could be versioned with two counters e.g.: nspawn --image=/path/some/directory/ picks the image from that directory based on counters Version format is modified RPM version format Directory suffix to signal that a directory organizes objects with this version specification inside. e.g.: ./foo.a/ has image(s) for resource foo version a (with a following RPM versioning format) ./foo.b/ has image(s) for resource foo version b TODO #7: add to sysext spec TODO #10: repart remove old / outdated partition that is not useful anymore Problem: usr/root partition is fixed after initial boot and repartition TPM provisioning, enrolling, measurement, remote attestation# Set up a Linux PCR registry, with a public list of which project claims which PCR, to allow vendor-independent coordination Keylime is used in SUSE Measures using IMA hashes Initrd measured twice Fedora CoreOS also looking into keylime for on boot remote attestation DICE as a reference architecture TCG specification Documentation from Microsoft OS factory reset# Prior Art# Fedora CoreOS has a WIP tracking issue to support factory reset Endless OS currently just erases users \u0026amp; data, implemented as enabling a systemd service for next boot which disables itself once run Flatcar uses a flag file in the ESP which is picked up and acted on by Ignition in the initrd, causing re-deployment of user config Ubuntu core supports reset via recovery partition (image file in ESP) SUSE MicroOS keeps BTRFS snapshot #1 around, and it can be selected from cli or bootloader menu Future Developments# Full reset vs. selectively keeping wanted local data Selective reset would allow reconfiguration for OSes which apply config at provisioning time (Flatcar, FCOS). large downloads (e.g.container images, databases) would remain while config could be updated benefit over using configuration management (Chef, Ansible) is that deployments remain idempotent, no config drift TODO #12 has a sub-item to add support for removing files to systemd-tmpfiles to better support partial reset systemd-repart can mark a partition for factory reset, will re-initialise / clear those parts first, then continue boot Reset is triggered by an UEFI variable - in repart, but other systems use different ways (see below). TODO #12 tracks standardising on reset. Also align on high-level target to reboot into, so desktops can provide menu to request factory reset Repart also supports filling the partition if the UUID is set to 0000… Add the same for 0xFFFFF to signal full factory reset (full repartitioning) for the disk GPT How to restore factory config, and apps stored outside the OS image? Tmpfiles support for removing stuff only on factory reset mode - tracked here Handling recovery partitions (Ubuntu core) Image could be updated but usually isn’t (security vs. robustness) TODO #13 update Discoverable Partition Spec to define flags indicating purpose (boot, sysext, recovery). sysupdate would not consider recovery partitions in A/B update scheme. Distributing OS images# Prior Art# rpm-ostree builds OS images on the server side and distributes the resulting tree\nOptionally, a new layer can be built locally and overlaid on the base When the base image is updated then the local build + overlay are repeated Multiple transport channels are supported, e.g. static website (with static deltas, or individual object pulls, similar to Git). container registry Initial installation uses image from (Live) ISO (w/ installer for automation), but image can also be dded to disk directly 3 release streams, user chooses which stream to follow Endless OS\ninitial install is from GPT disk image dded to disk updates are ostree images, composed server-side from debs. No local layering (like rpm-ostree does) Transport channel is static HTTP Clients fetch a delta from current revision, if available on server; otherwise, missing files are pulled individually Ubuntu core distributes a filesystem image that can be dded to disk\nEverything is shipped as snaps (in squashfs images) on boot, writable space contains 1 or more versions of base OS squashfs, \u0026ldquo;current\u0026rdquo; / \u0026ldquo;good\u0026rdquo; one is mounted on /. Apps are snaps too, mounted similarly. Xdelta for image (snaps) updates Transport channel is http with proprietary server side supports detached signatures based on hashes of snaps Xdelta deals with squashfs mostly fine, deltas are created on-demand server-side Flatcar: initial provisioning is full image, via cloud store / marketplace or manual download from image server (https). Image contains full partition layout; root partition is extended during provisioning to fill whole disk\nFlatcar updates are full images, no delta. Combined kernel+initrd+OS partition, all signed Update from any version to any other. Updates are orchestrated using the Omaha protocol, (Chrome OS update protocol) Omaha is a \u0026ldquo;control plane\u0026rdquo; layer on top of transports; clients poll for update Allows controlled roll-out (only X clients at the same time) Feedback channel from client to server, so server \u0026ldquo;knows\u0026rdquo; how many clients succeeded / failed. Roll-out can be stopped if too many clients fail \u0026ldquo;update succeeded\u0026rdquo; uses \u0026ldquo;boot succeeded\u0026rdquo; semantics, i.e. user-defined system critical service units must start successfully, else update failed Implemented in Nebraska server, is FOSS Update transport channel is HTTPS, but Nebraska is transport agnostic and could serve any URIs Flatcar offers 4 distinct channels: Alpha (developer), Beta (production-ready, for canaries) and Stable. LTS is a \u0026ldquo;golden stable\u0026rdquo; that receives only patch updates for 18 months. Patch releases go directly to each channel, new major releases are stabilised via Alpha -\u0026gt; Beta -\u0026gt; Stable transition Future Developments# Systemd-sysupdate\nIs an updater for DDIs, but could also do directory trees. Command line tool to apply updates. Information on how to update is inside the images themselves Point sysupdate to the image, and it will be updated if needed (current version lower than image) Built around lists of objects, version compared Manifest of object store server-side as sha512 sums file Compares version of what’s local, and what’s on the server, and gets right thing Will be able to use casync as transport, which chunks an image (like zsync) into files (unlike zsync). Hence zsync needs http range requests server-side, casync does not. Configurable chunk/block size; download size vs granularity trade-off left to owner/user Giant pile of files (== individual chunks) on server, to be CDN-friendly Always reconstruct target from seed, ideally could be used for backups (e.g.: homed) Idea: create a TPM signed report which includes manifest for images, and also metadata about node itself (PSI etc), orchestrator collects these from nodes on a timer and produces credential that can only be decrypted by that specific node in that specific state sysupdate transport is built-in (http) but should be pluggable - see TODO #16 TPM counters could be used to guard against unwanted rollbacks (downgrade attack).\nTo still allow regular rollback,sliding window of allowed counter values could be used Counters can only go up, need root to change. TPM can be reset by root, but lose all keys. Updating moves window forward. Systemd at boot will bump counter, with graceful fallback in case counters do not work/not available Vendors increase upper end on new release, increase lower end when cutting out older release Signed PCR policy will include info about acceptable counters window Client will be brought up to speed, as counter can be increased by any value TPM monotonic counter support in tpm2-tools: https://www.mankier.com/1/tpm2_nvincrement By spec, at least 3 counters per TPM, but nothing uses them anywhere Does not allow multi-boot systems, as counters would not match Tracked in TODO #14 systemd to support rollback protection with counters Shim supports Secure Boot Advanced Targeting (SBAT), stores counter in signed EFI variable, supports multiple vendors/distros.\nWhen booting a new version, old version can be marked as invalid, as EFI variables encode component names and minimum version uses authenticated variables to store the policy (distro + version) allows multi-boot systems, and cross-vendor/downstream distributions sd-boot/sd-stub already embeds SBAT csv initrd could be covered, too, with additional optional SBAT entries TODO #15 add support for SBAT of inner UKI images (initrd), add SBAT to verity signature JSON in DDI, if kernel includes SBAT either sd-boot needs to check it through shim, or combined them in the outer UKI SBAT SBOM\nmkosi builds and publishes manifest file in custom JSON Flatcar has an SPDX SBOM, a JSON file with version/license info, now it also added SLSA provenance SUSE SPDX and CyclonDX to build a standard manifest file provenance/tracking uswid coswid slsa TODO #17: add SPDX support to mkosi, tracked here TODO #17: add SPDX field to extension-release/os-release SPDX= or SPDX= for self-contained DDI Live updates for kernel and userspace w/o downtime\n\u0026ldquo;rocket surgery\u0026rdquo;, many pitfalls driver states / network queues etc. a problem, needs 100% control over hardware some HW state like TPM measurements are not resettable kexec can handle kernel w/o downtime, and w/o impacting user space CRIU to update userland? Start userland in a VM and then move userland processes using CRIU But what state CRIU migrates is opt-in, all things to carry over need to be specified explicitly systemd-suspend uses freezer cgroup to stop everything except pid1 But needs to re-arrange cgroup tree, which might break things systemd interested in hierarchical model of freezing, in which states can be passed up extend File Descriptor store so that state is persisted across kexec too (opt-in), using persistent memory, so that for a service a restart of the service or a kexec are the same userspace \u0026ldquo;reboot\u0026rdquo; (possibly with an \u0026ldquo;exitrd\u0026rdquo;, which is different from \u0026ldquo;initrd\u0026rdquo;, and resets some kernel state like /dev/), shut down everything and re-initialise to default.target, after switching to new root/usr DDI But need to figure out how to deal with TPM secrets that are phase-specific, but not different from kexec Could stop measuring after the \u0026ldquo;first\u0026rdquo; boot phases "},{"id":11,"href":"/docs/minutes/2023-09-12__image-based-linux-summit/","title":"2023 09 12 Image Based Linux Summit","section":"Minutes","content":"﻿Image-Based Linux Summit Berlin 12th September 2023# Attendee\u0026rsquo;s projects# Systemd Meta: mkosi, systemd, remote attestation SUSE: Aeon/MicroOS/Tumbleweed Redhat: image-builder/osbuild, systemd, systemd-boot Microsoft: confidential containers, flatcar, Azure Boost, Mariner Edgeless Systems: Constellation, confidential containers NixOS: systemd-{repart,stub,boot,cryptenroll}, Tvix Store, Lanzaboote, UKIs, NixOS Bootspec,, PE binary manipulation in Rust Canonical: Ubuntu Core, snaps, foundations/bootloader/package management System Transparency: UKI, UAPI specs, systemd-cryptenroll, remote attestation, TPM eventlog, mkosi Amazon Linux Freedesktop-sdk GNOME OS carbonOS Summary of Last Year’s Progress# UAPI Group established Website! https://uapi-group.org Github org https://github.com/uapi-group Report on previous summit: https://lwn.net/Articles/912774/ Systemd: systemd-boot/stub: addons support (only cmdline, dtb incoming) Systemd-stub: confidential VM support UKI: new sections in the spec for metadata (uname/sbat) Ukify: build UKIs, embed measurements and signatures Calls systemd-measure, sbsigntool Mkosi now supports UKI directly, building of initrds Uses systemd-repart, unprivileged, can use from containers, UKIs support with PCR measurements bells and whistles, embed OS inside UKI (small img), massive refactoring, broke everything and fixed again (?), presets (multi-image layers in same build, as dependencies for sequential stages of build), initrd built directly without dracut, almost reproducible (WIP), improvements around secure boot signing, supports grubs (unprivileged, shim works if it is installed to /boot), credentials support in cfg file Systemd-measure: PCR11 measurements and signing for UKI Pcrphases: advances the PCR during boot (initrd -\u0026gt; rootfs transition) Kernel-install is C and has plugins for UKIs Systemd-repart: running unprivileged, minimization of filesystem, support dm-verity, reproducibility (repart itself, but mkfs.* might not), direct writing of file system contents, subvolumes for btrfs (needs privileges) Bootctl: garbage collection of /boot (bootctl unlink), delete kernels that are not referenced, bootctl cleanup for other files as well, bootctl identify/inspect Early-boot detection of battery critical levels Smbios support: pass kernel cmdline, credentials AF_VSOCK support in systemd: sd-notify support to pass back state changes to hypervisor (ready, failed, finished) Credentials: almost everything that takes config files takes credentials (no udev, no units) Can now process credentials from systemd generators RPM gained native support for sysusers Softreboot Skip kernel restart, jump to new rootfs Pass state across via FD Store, retains /run Can configure some services to survive TPM: offline sealing Get TPM public key, provision secrets from different machine Confidential computing support: setup SRK before VM instantiation, using to seal secrets Fully encrypted sessions, pin SRK, create SRK if not present already Confext: equivalent of sysext (system extension) but /etc Grub: patch sent for UKI support, under review AI Luca: enquire about state NixOS: Working on Rust version of systemd-stub Uses repart for DDI Bootspec: high level config to support multiple bootloaders Rust implementation of ukify: goal to do everything in-process without shelling out Systemd-sysupdate + repart integration tvix-store for serving content addressable parts of (system) images: some sort of blob protocol relying on Merkle trees / BLAKE3 constructions We have a systemd-based initrd implementation finally with networkd Flatcar Uses systemd-sysext for A/B updated OEM software (cloud vendor / virtualisation guest tools) sysext-bakery gives simple scripts for users to build custom sysext images, prebuilt images published as github artifacts with systemd-sysupdate config (signing WIP), sysupdate can consume them flatcar-reset tool: stage reset on next reboot, with optional regex to keep files around /etc is now overlay mount, lowerdir is on read-only /usr/share/flatcar/etc, /etc remains writable (/etc is upperdir, unmounting overlayfs still results in a working system, needed to suppress a few tmpfile rules to prevent upcopies) OSBuild Support for UKI (native implementation) Ubuntu: TPM support by default on generic distro Snapased: kernel updates, measurement updates Uses systemd-stub Systemd-based initrd in Ubuntu-core Ubuntu-core initrd+kernel snap used for tpm-by-default desktop Native upstream cryptsetup Precalculate PCR measurements White paper internal, not published yet GNOME OS: Sysupdate support, already used sd-boot Repart on firstboot UKI support, with dracut SteamOS supports sysext too now SUSE Shim trusts signed systemd-boot in openSUSE YaST support to install with systemd-boot in MicroOS (tooling works on Tumbleweed too) PCR Oracle tool for PCR predictions Aeon (formerly micro-os desktop), sd-boot, image-base-install, full FDE by default no option Tumbleed installs everything into /usr (no longer /boot) work in progress on /etc too Anaconda installer Supports sd-boot Topics# Not covered# Integrity of OS images, via Verity and so on. Updating OSes safely and robustly in A/B fashion Booting OSes in A/B fashion Provisioning image-based OSes with credentials, parameters and similar Signed kernels, root fs + SecureBoot Hermetic /usr/ + Hermetic /etc/ TPM provisioning, enrolling, measurement, remote attestation Composing/Modularity of OSes based on multiple images Build systems for OS images Version management, rollback control Vendor/User Resource isolation Reproducibility of the build process Bootstrapability of build process (https://bootstrappable.org/) Secure configuration management (signed configuration updates) OS Image formats Unified kernels + pre-built initrd Disk encryption in images Novel Linux file system technology for immutable OS images (blobfs, …) OS Factory Reset Systemd-pcrlock TPM event log Securely pass cmdline to UEFI via UKI (we deprecated SystemdOptions UEFI var recently) Shim How to split up root vs home partition space Use OPAL Covered# Sysext / confext and mutable /etc, /usr, and /opt (https://github.com/flatcar/Flatcar/issues/986#issuecomment-1571429705 , https://github.com/systemd/systemd/issues/24864#issuecomment-1576792335 ) Currently sysext/confext overlay is R/O Can we add a writable layer/mode (not default) R/W can be ephemeral or persistent OS layer at the top? Right now at the bottom of the stack Fix it by symlinks! Always the answer AI: add ordering guarantee to sysext spec AI: rewrite config spec on uapi-group to remove XDG duplication Ideally: overlayfs mode that allows creating new files, but not modify existing files from other layers AI: Propose an extension to sysext and confext specs on uapi-group for mutable and ephemeral modes. Hermetic /etc SUSE adds support for libeconf in upstream projects apache2/nginx still need files in /etc to work, part of openssh, complex configurations files (xml or so) Fedora also has patches /efi vs /boot vs /boot/efi vs /run/efi filesystem on SUSE is rpm that creates base directories Base-files on Debian/Ubuntu Top-level directories are problematic as mountpoint for this /run ? runtime object, but solves rpm problem, also there are assumptions in systemd about resources /run Offline mounting also problematic, tools assume /run is not there before system is booted, ordering problem /run mounted by container manager/init Ideally, use automount Why do we even mount it? Because: bootctl/fwupd/kernel-install/logind(r/o) Ideally only one tool touches bootloader after all updates are applied to disk Xbootldr partition vs esp, if both available then xbootldr needs go to /boot The most important thing is where to put kernels So if xbootldr partition, then mount it on /boot If no xbootldr then ESP to /boot So kernels are always installed to /boot Places to put bootloader is not stable Bind mount or symlink, but implementers of bls need to understand this Spec for BLS: https://uapi-group.org/specifications/specs/boot_loader_specification/#mount-points Conflicts with Discoverable Partitions Spec: https://uapi-group.org/specifications/specs/discoverable_partitions_specification/ (explanation for ESP GUID table) DPS says default is /boot, BLS says /efi Tools do it the DPS way Fix BLS? /boot as default https://github.com/uapi-group/specifications/issues/35 AI: send PR and merge Tools shouldn’t mount twice /run/efi can be mount/bind mount/symlink to ESP? APIs bootctl -p or -x as API to find location of ESP Bootupd as API for grub support for BLS in Fedora Do we need new API? /dev/-by symlinks? Install kernels ‘here’, bootloader ‘here’ Still need to dedup in readers bootctl/kernel-install as multicall that can be called or provide service with varlink, works inherently with –image/–root Bootctl-varlink.socket AI Luca: open RFE on github.com/systemd/systemd Sd-boot recognizes what an EFI binary is via .sdmagic Dual boot causes a lot of problems Makes our lives complicated, do we really need it? Developers need it for hw-related development Not supposed to measure efi entries that are tried, only the one actually booted Windows: set BootNext and reboot Sd-boot supports it but only in ‘bitlocker mode’, should be made generic when switching OS UEFI has boot counter in the spec, so writing to variables should be fine Talk about AWS/Azure/GCP IMDS (early-boot link-local networking metadata server) and credentials / generators / network config Some previous discussion between Arian/Lennart: https://gist.github.com/arianvp/22e1c5182eb6c17bbd8c1bbe823b516b Networkd cloud-provider-based configuration: https://github.com/systemd/systemd/issues/16547 VBE: https://u-boot.readthedocs.io/en/latest/develop/vbe.html — alternative to UEFI for embedded systems, maybe more? NixOS looking into this, for coreboot support Specs covers boot flows, OS requests Interoperates with UEFI Other firmwares: tianocore/edk2, slimbootloader, LinuxBoot, u-boot, coreboot, SeaBIOS Emulate uefi on bios Nix has some shims to support UEFI variables Uboot can be build as bios payload, with UEFI upper layer, store variables in TPE or text files on boot partition or just leave everything volatile Google has KVM solution Clover EFI bootloader for BIOS, see configuration Question: is there a UEFI protocol to detect that persistent vars are actually ephemeral? Fedora: proposal to drop bios support, but protests, 30% of machines bios-only, still hybrid Amazon Linux 2023 has dual bios/uefi hybrid support Hybrid images: tricky to support everything because of 512/2048/4096 partition headers. mkosi tried but gave in on El Torito support. Provisioning systems for VMs SMBIOS support in sd-boot/stub Alternative: ACPI device that can send notifications SMBIOS technically is static, although one field can change at least: suspend/resume field (int) for reason of change Also data might not be ready when guest is booted SMBIOS is already supported widely ACPI needs a driver Requirement: userspace needs to ask for data and wait synchronously, don’t want to boot and then data appears later SMBIOS guarantees that data is already there ACPI can generate data on the fly when requested Systemd provides point at boot where we require data, hypervisor needs to provide it Dracut has pre-existing infrastructure on this topic Sd-stub already supports picking up resources from ESP, also reads smbios New transaction in initrd, units that generate other units Also needed to know if /root is tmpfs in installer image New targets where to hook the metadata Network namespace + VRF for cloud-init and similar to get provisioning info Amazon: provision user’s UEFI variable database Addon: PE non-code binary that can be verified by shim/uefi, append kernel command lines Credentials can be provisioned from /run in initrd to rootfs transition At the new mid-initrd target, provisioning tools prepare creds in /run Then systemd reloads and does second transition Credentials Provision SSL cert via creds Need to update it How to do it at runtime? If done live, atomicity is lost Restart service? Use FD store to keep sockets and resources order We will need conftext live reload Mount “beneath” to replace mount point atomically Can do the same for creds? We have the semantics for systemctl ‘reload-or-restart’ already We do not have good docs on fdstore Do we want an API for “Hey what services depend on what credentials so I can restart them” Future improvement: systemd-creds can encrypt to asymmetric TPM SRK so that creds can only read Let\u0026rsquo;s document $CREDENTIALS_DIRECTORY as static for system services.by confidential VM API to create/enumerate credentials is missing Sd-creds as multi-call binary with varlink service Problem: reading creds requires looking at env var, but software doesn’t like the interpolation AI Arianvp: change doc to document that creds path for system service is fixed with precise caveats and warnings to avoid being it misused sd-ask-pwd: no solution for user services More complex issue, needs integration with desktop managers Tracking issue: https://gitlab.gnome.org/GNOME/gnome-shell/-/issues/6921 Kernel keyring has advanced lately, very complex TPM stuff Currently involves PCR11 (kernel/uki) and PCR15 (system identity) How to cover PCR 0-7 which are owned by firmware? Answer: systemd-pcrlock Instead of changing the superblock on fw update, change the policy in the TPM Attach objects to the TPM policy, when changes are expected change policy objects Disk encryption binds to policies, not measurements .pcrlock files define component involved in boot, even after fw -\u0026gt; kernel transition, json format following TCG measurement log format (but not 100% the same) Allows drop-ins and alternatives for components (eg: run multiple kernels) Generates lock files from what system measured at some point via tpm log If fwupd shipped the pcrlock file with an update then we wouldn’t need to measure on-the-fly, current LVFS stores result of pcr0, instead store measurement Only vendor can know what firmware will measure, so vendor has to provide it Pcrlock tool orders drop-ins by filenames If fwupd doesn’t know what measurements are going to be, it can remove the pcrlock drop-ins that corresponds to the component Pcrlock will recognize that there are holes, and remove that pcr/measurement from the policy If info is there, secrets are always protected If info is not there, secrets are not protected by those pcrs for one boot Improvements: reboot twice to apply changed quickly and minimize window Windows also reboots twice on unexpected fw update, but changes block device and re-enrolls in Bitlocker Can lock against firmware, can deal with firmware updates, if vendors collaborates no ‘open’ policy window Local/hw specific vs OS vendor (uki) Also solves rollback protection Recalculate automatically on reboot so that it always uses the most secure policy possible Can generate from gpt, uki, pe, current event log Trust-on-first-use model Transparent log database with pcr values of known hardware - if anything changes in the uefi (option) they change - from TCG How to recover from failure - recovery key? How to restore a usable policy? Reset TPM? Can the same recovery key for LUKS2 be used? Ubuntu Core also implements a similar infrastructure Changes the LUKS superblock on updates Can be analyzed offline Systemd has event log, that works like TCG firmware event log, for measurements done at runtime, v255 Json-seq, not array but separator-separated blocks so that it can be append-only Stored in systemd-specific dir so that it’s private Would be good to allow other usespace app can append But need atomic behaviour (file lock, append-only) Public API dbus/varlink AI Lennart: libsystemd sd_measure(⋅) which takes data and hash it for the consumer Kexec(/crashkernel): measure nonce so that it cannot be predicted and change policy, so that it works only on that kexec Ubuntu Core stores encrypted object that allows to reset the TPM on factory reset Systemd should have a hook for this Ubuntu core code: https://github.com/snapcore/secboot Non-disk-encryption usage of TPM VMs in GCP use TPM for remote attestation on container-optimized linux (fork of chromeos), not on generic linux distro, precalculate expected PCRs System Transparency (https://www.system-transparency.org/ ): remote attestation oss project. Code https://git.glasklar.is/system-transparency/core Attested TLS: developed for SGX - standardization happening, RATS, remote attestation for TLS Bind confidential computing to remote attestation Keylime uses TPM for remote attestation, integrated in MicroOS Talos does Build reproducibility helps for build systems attestation, but it is expensive, so many prefer attestation/authentication as an alternative Confidential computing Amd sev vs intel tdx, amd uses tpm Full vm confidential comp vs kata containers, but still needs measured boot In Azure firmware does measurements in vTPM Thread models driven by soc - intel/amd - no common specification Unified kernels + pre-built initrd Pass initrd via PE binary, lose ordering guarantees because filenames are not trusted Dtb addon patch adds matching based on content of dtb .mucode for microcode section in UKI, and magically make it first in the generated cpio Systemd-sysusers and user users A switch will be added to copy /etc/skel Can also drop json blob for userdbd to pick up in /run/ for transient user user, never show up in /etc/passwd → also great for hermetic /usr with json blobs in /usr/lib/userdb/ pam_mkhomedir can also create the directory on first login Homed in openSUSE Aeon: many papercuts, mainly storage burden Need to know a lot of stuff for provisioning ahead of time (like number of users) Encrypted btrfs subvolume as a solution, don’t need to know size ahead of time Lots of work going on in Gnome, lock session and remove disk keys from memory Interactive resizing negotiating between users if disk needs to change (owner user will be authenticated and asked to agree) SELinux policy for homed needs a little work Fedora actively fixes systemd selinux issues if they are reported with logs Some users in Nix also use homed, but with fixed user, also on Fedora there are some users but unofficial Ongoing work in Gnome is to make it trivial to enable homed in distros How to split space between /home and rootfs New partition type in repart using dm-linear to add an extension for another partition on-the-fly Android uses it, no measurable performance penalties for having many dm-linear extensions / as opal encrypted (cryptsetup will support in next version with LUKS2 for keys), then homed LUKS2+dm-crypt loopback q devices Homed could use creds for initial setup Sysusers runs much earlier, homed need a lot of stuff set up, runs very late Why not just use ZFS? Action Items# allow opt-in creation of “normal” users via sysusers (Possibly use pam module to create the directory on first login?) bootctl -X (name TBD) to print all paths containing boot loader entries[a][b] bootctl status \u0026ndash;json Link sd-boot BootNext generalization github ticket https://github.com/systemd/systemd/issues/22390 Arian sends documentation PR about credential path for system services AI: fix incompatibility w.r.t. Mount points between BLS and DPS AI: ask shim to cap sd-stub’s PCRs (os vendor name or so) AI: start issue or so to track hermetic-usr work-in-progress AI: create spec for drop-in style config management AI: add ordering guarantee to sysext spec AI: Propose an extension to sysext and confext specs on uapi-group for mutable and ephemeral modes. "},{"id":12,"href":"/docs/minutes/2024-09-24__image-based-linux-summit/","title":"2024 09 24 Image Based Linux Summit","section":"Minutes","content":"﻿Image-Based Linux Summit Berlin 24th September 2024# Attendee\u0026rsquo;s projects# systemd mkosi SUSE: MicroOS/Tumbleweed Red Hat: image-builder/osbuild, bootc, systemd, systemd-boot Microsoft: confidential containers, Flatcar, Azure Boost, Mariner/Azure Linux Edgeless Systems: Constellation, Contrast (confidential containers), uplosi NixOS: systemd-{repart,stub,boot,cryptenroll}, tvix-store, Lanzaboote, UKIs, NixOS Bootspec, PE binary manipulation in Rust Canonical: Ubuntu Core, snaps, foundations/bootloader/package management System Transparency: UKI, UAPI specs, systemd-cryptenroll, remote attestation, TPM eventlog, mkosi Freedesktop-sdk GNOME OS Pengutronix: OE/Yocto, nspawn, RAUC, verity, OPTEE Arch Linux: sbctl/go-uefi, signstar, mkinitcpio, arch-install-scripts PostmarketOS Summary of Last Year’s Progress# Flatcar: Sysexts widely adopted: In-system (shipped with OS), optional but system dependent (updated in lock-step with OS, like podman/ZFS), Custom / user provided (updated from custom servers via sysupdate) Composable OS is more flexible, some traction with contributors, even vendors (Akamai) Mutable sysexts feature available in systemd-256 and newer. Slowly trickling into distros. OS test suite keeps finding bugs in LTS kernel patch-level updates 😅 NixOS: Systemd-repart integration to build NixOS images Recent dm-verity support for /nix/store (incl. offline Secure Boot signing support) UKI available by default https://github.com/nikstur/userborn like sysusers but can create “normal” users and “remove” users https://github.com/nikstur/nix-store-veritysetup-generator for storehash Edgeless: Not much progress on package manager lockfile proposal Talk about reproducible OS image builds with mkosi @ fosdem (repo) uplosi tool for uploading OS images to cloud provider, can pre-calc PCRs for measured boot (started pre-systemd-measure) openSUSE MicroOS systemd soft-reboot with transactional-update (switching btrfs root subvolume) Full disk encryption with systemd-pcrlock / signed policies (TPM and FIDO2) Working on BLS support on all architectures Systemd-boot integration in YaST2 Installer and all relevant tooling GNOME OS Significant investment in integrating systemd-homed with GNOME (WIP) systemd-sysupdate integration with the GUI app center (GNOME Software) Various improvements to systemd-sysupdate (optional components, bug fixes) Integration of systemd-sysext into GNOME’s CI pipelines - testing system components as easy as Flatpaks for apps Switch to ukify, drop dracut We now use systemd main branch systemd Tons of stuff, see ASG Thursday LPC Uapi wishlist room https://uapi-group.org/kernel-features/ contributions welcome (via PR) Session on initrd changes Initrd are quite large with UKIs, need to rm -rf content, tons of work to do, unnecessary We have some agreement on umounting initrd from the host New root filesystem type as the immutable / (single inode) that can stay around, initrd mounted on top, so it can be removed Page-aligned erofs images packed in uncompressed cpio, kernel could zero-copy use them, so we avoid copying/uncompressing on boot No agreement on immutable via erofs mkosi Now fully unprivileged (fs generation via systemd-repart) BTRFS work ongoing to do offline compressing/subvolumes No more bubblewrap/newuidmap mkosi-sandbox instead of bubblewrap More scripts (version, config) Mkosi-initrd as an easy to use tool to build initrds locally Various new distributions Azure Linux OpenSSL engine support for HSM signing (signed) shim, systemd-boot, grub support Sysupdate support Red Hat Image Builder / osbuild dm-verity support not yet used in the base image, for automotive use cases bootc-image-builder: https://github.com/osbuild/bootc-image-builder/ based on rpm-ostree https://uapi-group.org FOSDEM CFP open, will prep a proposal Image Based devroom Kernel: IPE LSM is now upstream (in v6.12), image-based distros can do code integrity not yet for scripts, there’s ongoing work for that Topics# Dual-booting DPS distros, DPS partition ownership (https://github.com/uapi-group/specifications/pull/117) New installer for GNOME OS, no longer supports /etc/fstab Cannot identify which root/usr partition belongs to which distribution home/srv are shareable two instances of the same os is not supported rootfs discovery is done on pattern matching on labels (implemented in sysupdated, not in the spec yet) corresponding /var partition is found via hashing of the machine-id related: mkosi images with integrated /var currently needs a fixed machine-id Q: Who has adopted DPS in production? Emil: not adopted in SteamOS, as not the full partition set could be discovered We can add label-based matching/filtering. There is an open PR for that. Need backward compat, if there are no labels do the autodiscovery People do want to use F39 and want to try F40 and maybe go back, so multiple versions of the same OS can be useful Pick the rootfs, then the rest is derived (home shared, var hashed by machine-id) Comment: It’s hard to specify root= with UKI Solution: new credential, TPM locked /etc/os-release add new field, or re-purpose IMAGE_ID Generic, stateless OpenPGP verification of distribution artifacts (repositories, packages, installation media, updates, etc.) Links: https://github.com/uapi-group/specifications/issues/115 https://github.com/systemd/mkosi/issues/3042 https://codeberg.org/heiko/rsop Tons of pitfalls, gpg not standard compliant anymore, is not stateless with regards to keyrings Would be great to have stateless (no keyring) thingy for signatures why not PKCS#7 Apt has global trusted.gpg.d directory, being phased out, specified inline in the src line seems similar to how distros handle TLS certificates differently systemd currently could use this for verity authentication and downloading suggestion: write a UAPI spec (agnostic with regards to OpenPGP or PKCS#7 or SSH?) PKCS#7 is x509 so that additional things can be added, like application-specific purpose extensions https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.12 Spec says where to put keys, how to name them Key need a purpose, path specifies it, so that a key cannot be used to add trust to another key, only to a repo Should support the usual /usr/, /etc/, /run/ priorities Directory structure should be used to find the right key (apt key or sysupdate key), but key policy should be inside the key (signing key or bla key) find key type from the file name suffix Not turn it into a Certificate Store thing, like openssl Have a way to find a private key corresponding to a public key Reserve some OIDs for usage, or define usage extension fields would like to add a security feature (BPF LSM) to reject any access to an unauthenticated FS dm-verity/dm-crypt or fixed list (sys, proc, …) also reject any dev nodes outside of /dev chromeos has something similar Reject AF_UNIX sockets in /etc/ or /usr/ Any other “no-brainer” security policies we should add globally? TODO: file RFE on systemd to track list of policies BPF LSMs are often closed-source currently Make program visible in BPF FS when loaded, so you can do ConditionPathExists=/sys/filesystem/bpf (TODO: fix this) Think about the relation between FIDO2 + TPM2 (tpm2+fido2 as PIN, TPM2 and FIDO2 as recovery key) No two factor auth, it’s either TPM or FIDO Chromeos makes the tpm send a challenge to the fido device, then the TPM reveals the encryption key could likely also be used with PKCS#7 HSMs SSS (Shamir Secret Sharing) support was being worked on, but keys are combined in software on the CPU, so the spooks can get at you SSH agent could also use this scheme TPM policy expresses that there must be a challenge-answer Q: use this for remote proof of identity? we have PCR15, which includes machine-id and could have other identity identifiers immutable without significantly raising the bar for contributors https://gitlab.com/postmarketOS/postmarketos/-/issues/62#note_2095562422 How to deliver an immutable system without raising complexity Need to figure out how to build image Image build efficiency: composefs Q: how about sysexts? Thilo: there are plans to load sysexts very early (initramfs). Also can create systexts on the fly - using mutable overlays and capturing the writes in a separate “working” directory, then building a new sysext from that perhaps do an overlayfs and keep a list of user-installed packages? This completely breaks the security model For developers, it makes sense for a “break glass” mechanism to do things locally For users, the update mechanism should be designed with security in mind and do transactional updates Think hard on whether the immutable system is the right approach for the use case a way would be to use local keys to build images locally. but uses the full image workflow. They currently use apk and install packages into an overlayfs, purely additive. the overlayfs would become incompatible on update, so nuke it. This kind of issue will become bigger when moving to UKI. Seems like using measured boot is much more interesting than secure boot. Perhaps mkosi approach, keep a list of packages and generate a locally signed sysext. then refresh the sysext Just build the full image locally, no need for sysext if you can sign everything yourself maybe have a “developer mode” like chromeos. there is an entry in the systemd todo list gnome os is looking at this as well have an explicit knob in the TPM for this NIXOS has a similar mode On qualcomm phones there is no way to have a fTPM in TrustZone systemd on musl https://catfox.life/2024/09/05/porting-systemd-to-musl-libc-powered-linux/ pmOS is for smartphones, they have a high number of contributors relative to the number of users Tons of patches We merged some patches they (adelie folks) use s6 parts to support group shadow stuff that’s required by systemd have a shim library when using systemd on musl pidfd_spawn, shadow/gshadow, printf string formatter, detected by pkgconfig Maintain shadow parser and printf in parallel with musl needs to be done by libc experts systemd adds more nss stuff (userdb), might be considered advanced use cases locale support in musl is problematic (tests fail) there is conditional execution of tests in systemd already (e.g. when running in a container) Q: how is pmOS handling network A: NetworkManager, due to switching between mobile and wifi GUIs are also deeply integrated with NetworkManager be careful with musl on memory constrained systems, as they don’t release memory back to the OS Missing functionality for managing /etc/ as a writable confext Persisting /etc/machine-id Deriving the machine-id for /var/, even though /var/ is probably storing the mutable /etc/ context Handling presets. Store them in /usr/ somehow? Possible solution: Just mount /var/ from initrd? (Who does this actually affect, and do they use image-based / confexts / whatever?) Move mounts that exist on /etc/ when reapplying, writable /etc/ on top of the stack Overlayfs works by using the superblock for each elements, pins it, and doesn’t look at the VFS at all, so it needs to be handled by the confext layer How to handle cases where only /var/ should be persisted? repart uses the ephemeral machine-id to create /var/ there is now also systemd.machine-id=firmware Could add a mechanism to persist machine-id via tpm (NV index, allows factory reset) or system credential could also use the /var/ partition UUID as machine-id? problematic from the security perspective, needs some authentication perhaps reopen the discussion to mount /var/ early (in the initramfs) MicroOS already mounts /var/ (and /etc/ overlay) in the initrd things are a bit tricky around soft-reboot because there is no initrd Support for CC-based (confidential computing) runtime measurements (i.e. \u0026ldquo;PCRs\u0026rdquo;) in systemd-stub, systemd-pcr* Most systems have vTPM Should systemd support this if it detects CVM? problematic for Intel, as they do it differently compared to everyone else looks like they will move to a TPM API as well separate PCRs are required for disk encryption via TPM policies, not needed for remote attestation sd stub already supports some CC measurement log Use case: runtime generalised measurements Stuff we build in systemd are not ima based Industry largely is accepting that vTPM is the interface to provide to the OS If userspace uses the 4 intel registers to map to the 4 PCRs systemd uses, this could be hacked to work for very minimal/fixed userspace, tpm might not be needed, as everything can be measured at the start Unpriv container support/mountfsd newuidmap is bad We have mountfsd/nsresourced Doesn’t work with containers in the home directory Extend mountfsd to get file descriptor of directory instead of image file Predefine 65k users for containers, no dynamic, no system specific, always the same, statically mountfsd enforces that the setup matches, then checks the parent inode to check that the caller owns it, then set up id mapped mount Dynamic ranges get mapped to this static range Homed already uses id mapping, kernel doesn’t allow nesting. This will be fixed in the kernel to allow multiple mappings. FreeIPA has existing systems with large amounts of mapping, want to make it configurable But if OCI tarballs have to be built offline, no way to synchronise them Mountfsd also needs to learn to delete them, as unpriv users cannot delete files they do not own Once available this may be used for mkosi too IPC is via a varlink unix socket, so they could be used in containers as well via a bind mount Partition resizing discussion Should repart start resizing filesystems on its own? There’s nothing to resize vfat. What do we do if we want to grow the ESP? Gnome OS wants to use repart for the installer don’t resize ESP. use xbootloader Android uses dm-linear to runtime-merge partitions DPS GPT flag for extension partition to concatenate them with dm-linear Difficult to implement in repart for the allocation algorithm related: fuchsia has a blobfs, which makes everything accessible via a rootfs Confext dm-crypt+dm-verity loop End goal: being able to reason about every single inode on the system, with different owners/signers per component Agree with this, an issue with composefs because of the multiple layers Hermetic /usr/ + Hermetic /etc/ Easy parts done for MicroOS Some projects can’t have their files split, some refuse patches (some quite rudely) glibc would take patches, but they don’t want to do the work and it needs to be reimplemented in glibc MicroOS currently targets putting everything in /usr/etc/ and only using that as a fallback if sysadmins don’t put a file in /etc/ (libnss_usrfiles) tmpfiles + /usr/share/factory/etc/ + symlinks seems to work great suggest using volatile /etc and have an allow list for specific stuff for the base os we should be fine now (on fedora), except /etc/services MicroOS doesn’t have /etc/services any more related: /etc/protocols /etc/shells is read by many things directly use tmpfiles to create a symlink for glibc, most important is ldconfig, services, nsswitch.conf https://github.com/systemd/systemd/pull/34535 https://github.com/authselect/authselect/pull/380 it would be nice if overlayfs had a way to “reveal” (config) files from the lower layers you can diff between upper and lower layers Do we need a arewehermeticyet page? (there’s no “.yet” tld though) Yes Tracker: https://github.com/uapi-group/specifications/issues/76 (is now a pinned issue) maybe complain about packages which place files in /etc/? How to test whether packages? nix patches all packages which write to /etc/, can be used as a list of affected packages list of stuff that needs to be in /etc/ on Arch Linux: https://github.com/systemd/particleos/blob/main/mkosi.extra/usr/lib/tmpfiles.d/etc.conf also relates to random top-level paths (mount points in /, container usecases, /opt/) OS Factory Reset What to do with user content on the ESP (credentials, self-signed UKIs)? Original patch set for factory reset became purge, which then tried to delete home directories, which made some people unhappy https://github.com/systemd/systemd/pull/24983 Need to factory reset TPM There is an API for userspace to request this on reboot There should be a way to request factory reset from the boot menu that then triggers repart factory reset, TPM reset and something like bootctl factory-reset Should we have global directories to sort things by owner? Undecidable whether e.g. nVidia drivers should be removed or not, might be required for graphics to work, but maybe the factory reset was initiated to get rid of them let’s add a vendor directory that does not get deleted systemd-pcrlock Canonical wrote a whitepaper on PCR-based unlock, but it has not been published yet TODO: ask to get it published SUSE has adopted pcrlock Their older Dell laptops don’t support NV index policies The problem will resolve itself by waiting, until then we need graceful fallbacks Order of measurement is deterministic by PCR, but not globally across all PCRs Golden measurements supported, provided by vendor (in /usr/), derive the rest from hardware some laptop vendors provide PCR0 values for LFVS, but the actual measurement values would be better Ideally would supply measurements in the json format for other PCRs touched to the firmware pcrlock is not very user friendly Should have documentation pointing users to the obvious defaults that they should pick --lock=auto option like cryptenroll pcrlock status, like bootctl show what local hardware supports pcrlock in combination with signed pcr policies is fixed in v257 via key sharding Recovery key fallback Windows doesn’t do much user-friendly stuff, nobody knows their bitlocker recovery key GNOME OS: show GUI when measurements change, to tell the user ‘something’ happened, which PCR is different pcrlock will find a measurement that it can’t make sense of in the log No verb to machine-readable output, can be added This is the remote attestation problem, as you cannot trust the output of a machine booting a compromised kernel There was a bluetooth based project to tie this to a phone (FOSDEM ?? Ultrablue) https://github.com/ANSSI-FR/ultrablue User-friendly Lightweight TPM Remote Attestation over Bluetooth https://archive.fosdem.org/2023/schedule/event/image_linux_secureboot_ultrablue/ Delivering credentials via systemd-creds to initrd for non-UKI systems (type#1)? Define UEFI protocol to pass sidecars to sd-stub, which will look for it together with the filesystem-based ones Ostree adds a new menu entry on each system update Btrfs creates a new snapshot on any change to the rootfs (update, config changes, etc) Nixos creates a new entry every time the system config changes Can a credential be used instead of the kernel command line? Problem is GUI: we need a chooser in the menu By opening up the kernel command line choice, we need to ensure we are not opening up a security hole to let a user access the root user Action Items# file RFE on systemd to track list of BPF LSM filesystem lockdown policies Make program visible in BPF FS when loaded, so you can do ConditionPathExists=/sys/filesystem/bpf ask for Canonical whitepaper on PCR-based unlock to be published writeup for LWN, send draft to group CFP for FOSDEM for image-based devroom organise 4th summit next year CHECK BERLIN MARATHON DATES Try after ASG, if we can do ASG Tue/Wed mastodon posts about systemd v257 features add stuff to kernel features wishlist file “user friendly pcrlock” issue uki.d vs uki.vendor.d dropins for factory reset create PR for certificate directory structure make suggestions on other projects to invite (use Signal) "},{"id":13,"href":"/docs/minutes/2025-10-02__image-based-linux-summit/","title":"2025 10 02 Image Based Linux Summit","section":"Minutes","content":"Image-Based Linux Summit Berlin October 2nd 2025# 🖼️ 🐧 🗻 🥙\nAttendee\u0026rsquo;s projects# systemd mkosi SUSE: MicroOS/Tumbleweed Red Hat: image-builder/osbuild, bootc, systemd, systemd-boot, composefs Fedora: Bootc, CoreOS, Atomic Desktops (Silverblue, Kinoite) Microsoft: confidential containers, Flatcar, Azure Boost NixOS: systemd-{repart,stub,boot,cryptenroll}, snix-store, Lanzaboote, UKIs, NixOS Bootspec, userborn, Sécurix Canonical: Ubuntu Core, snaps, foundations/bootloader/package management Freedesktop-sdk GNOME OS Arch Linux: sbctl/go-uefi, signstar(os), mkinitcpio, arch-install-scripts, devtools, buildbtw / vmexec, voa postmarketOS: mkosi and immutable images, dev tooling Devicetree selection for OS installers Cockpit https://github.com/cockpit-project/cockpit test.thing https://codeberg.org/lis/test.thing composefs-rs https://github.com/containers/composefs-rs Aeon Desktop https://aeondesktop.org tik https://github.com/sysrich/tik Meta (image builders) Summary of Last Year’s Progress# Systemd: factory-reset (including TPM), varlinkified lots of building blocks for the installer so GUI progs can call into this IPC to prep disks, UKIs: multi profiles (pcrlock TBD), DTB auto selection, netbooting plus image-based stuff (pxeboot replacement), repart: verity autosizing, verity copyblocks, offline signing, systemd-sbsign for signing EFI and more stuff, with providers support and offline support, fsverity support SUSE: sd-boot for MicroOS, Tumbleweed uses BLS, TPM-based FDE in the YaST2 installer, fido2 + tpm2 integration being worked on, sysext support in MicroOS, building MicroOS images with mkosi as root, non-root is WIP, util-linux follows config spec, glib will support it with 2.87.0 too, prototypes to remove SUID from everywhere, new systemd socket activated daemons, one to read and one to modify passwd and shadow entries, simple PAM module making use of it, TIK installer repart based for everything, aeon tpm encrypted by default, fully image-based Composefs: rewrote in rust, can pull OCI images, or local filesystems repos, can use systemd-repart, integrated in bootc project, moving away from ostree, focusing on flow for secure boot signing and bootchain security, UKI and systemd-boot support in bootc Fedora: sysusers.d migration completed for all migrated mostly done in rpm inline as many are based on RPM macros, getting closer to have sd-boot signed, almost finished moving Fedora CoreOS to bootc, focusing on remote attestation, experiment with sysext for Atomic Desktops and CoreOS, not official yet, works well Ubuntu: experimental TPM based FDE for ubuntu classic, ubuntu core IOT related and does it already, many issues with firmwares so verification work, will be ported to classic, to handle common error cases, adding dm-verity for snaps, investigated using DDIs as backend\n(https://ubuntu.com/summit might be the place to evangalize, Oct 23-24), collaboration with azure for tpm-based CVM, no bootloader, nullboot (https://github.com/canonical/nullboot) manages the efi entries directly, uses shim → uki managing efi entries GNOME OS: sd-boot, sysupdate, worked on new installer using repart, pcrlock enabled by default, more testing this summer, issues like fw updates clearing the TPM (not uefi capsule based), problems keeping things unlocked (no recovery key setup sometimes, needs UX improvement), wired up gnome ci to produce sysext images from PRs for easy testing, btrfs installer that does not reboot, puts root btrfs in zram device, encrypt and open luks, then btrfs moves to the disk from the zram (https://cfp.all-systems-go.io/all-systems-go-2025/talk/QRJVL3/) Arch: worked on stateless verification of artifacts that works with openpgp but extendable (ssh, x509, etc), added to UAPI specs, image based signing enclave using mkosi, NixOS: dm-verity support in builder (puts Nix Store on /usr/nix/store then bind-mounts to /nix/store). Uses veritysetup generator and verity autosizing. Removed Perl from mandatory system closure before, now removed bash. Convinced kbd to use .note.dlopen(). Proposed to logrotate as well but unconvinced we will succeed Happy about mount --beneath support in util-linux. Used for /etc/ overlay so when system updated it is done atomically Tried very hard to use the systemd (sysusers and userdbd (no uid allocation) and homed (not declarative, always prompted)) for declarative user management. After 6 months gave up (skill issue?) and developed Userborn. Couldn\u0026rsquo;t get homed to be fully declarative userdbd drop-in files are missing uid allocation and prevention of UID re-use Lanzaboote: not much progress except on admin/CI work, we are moving to a new git hosting and infra, we hope to resume efforts to be feature parity with stub at that moment. A lot are using it, 2 users claimed having burned their motherboard. snix-store: a \u0026ldquo;CA Nix store\u0026rdquo; for any data, used increasingly, at a slow pace. Sécurix: a French government-lead project to have a framework to build NixOS hardened workstations with minimal infrastructure, ships with an installer, ships with Lanzaboote, made for teams with an built-in static inventory. Interest to extend to more parties. Semantics not yet image-based. remaining funny problem: laptops are multi-user, we need to provision disk encryption for all the users who use security keys systemd on embedded devices: 16MB of libraries among 1.3MB of libsystemd.so, 2.2MB of libsystemd-core, 4.2MB of libsystemd-shared, 1.1MB of systemd generators, 1MB of udev, 5.4MB of systemd binaries systemd-pcrlock: we built our own tool to predict pcrlock-like files but we wonder if pcrlock should know how to predict things based on an event log for hardware and a systemd-repart manifest, this works perfectly machine identity and LoadCredentials: currently, we cannot use socket based LC because reloading rotated credentials is not perfect Appetite for multi-level security in Spectrum (QubesOS alternative in NixOS): https://git.sr.ht/~alip/syd a competitor to systemd hardening / sandboxing options Flatcar: operationalizing sysexts, building/publishing/hosting: https://extensions.flatcar.org/ more APIs/hooks for sysexts to make services merge/unmerge aware mutable confexts for a migration path from a fully writable to immutable setup, incl. Auto-generating / capturing confexts on the fly more productization for secure boot allow third party keys into sb database so that 3P sysext images can be used Topics discussed# Lennart: Lsm-bpf policies implemented by systemd How to forbid abstract UNIX sockets in service units\nUniversal truth: refuse listen on abstract socket\nAdd new option for refusing abstract socket\nShould use VRFs so that service is attached to internet but not interfaces\nsystemd.resource-control(5) should not contain security options that aren’t about controlling resources\n(side note about network-online.target w.r.t. Android semantics: see https://systemd.io/NETWORK_ONLINE/ for example of using ping in network-online.taget) or https://www.freedesktop.org/software/systemd/man/latest/systemd-networkd-wait-online.service.html\nAdd named bpf policies, but some might need to be configurable as individual knobs depending\nUse the same scheme as the new OOM policy, unit refers to name, and the policy is configured separately `Policy=` and takes a list of stuff, if that policy needs configuration, we put it in a separate configuration policy file: `/etc/systemd/policy.d/…` Zbigniew: Should be compile-time knob or unit setting instead of a separate new concept Current policies are parameterized Should prefer boolean unless necessary, and then it can have a config file Policies are fine but should be coarse, more higher level than selinux (‘app’ instead of ‘specific binary’) You need serializing BPF maps and stuff when there’s a vulnerable time window where the system is unprotected, esp. during early boot\nThere’s an open pull request (https://github.com/uapi-group/kernel-features/pull/38) to get rid of SUID binaries in the UAPI group. What we can do is we don’t allow SUID execution outside of namespaces via BPF-LSM. We predict that the future of privilege escalation would be to ask nicely to systemd.\nStart with the 5 universal truths\nUniversal truth: writable XOR executable mounts (superblock W^X) [lsmbpf] (F) Policy per cgroup (maybe xattr) Universal truth: device nodes only in /dev/ [lsmbpf] (F) Still allow zero device node (InaccessiblePaths=), null/zero and a few others for container manager Universal truth: SUID/fcaps are bad [prctl(), lsmbpf] (F) Pam fixed in git main Polkit fixed in git main Newidmap/newgidmap need a solution Universal truth: superblocks must be in-memory, encrypted, authenticated or prohibited (F) Potential new universal truth: FIFOs and sockets only in /run (incl. XDG_RUNTIME_DIR) putting sockets/fifos in tmpdirs in tests is super super common Potential new universal truth: fds [0, 1, 2] are always open at execve() boundary Potential new universal truth: nothing mmap’d PROT_WRITE|PROT_EXEC (even anonymous?) Measurement of boot phase (\u0026ldquo;fuse blowing\u0026rdquo;), staged boot (F+O) Separation confext vs. sysext (F) Use tpm as enclave for fundamental key material (tpm2 in systemd-cryptsetup and systemd-creds) (F+L) Delegate via sockets (varlink) (L) Prohibit setuid() to nobody user Call for new universal policies\nOverarching goal of having LSM provided by userspace and out of the kernel\nSeccomp filters installed are not done right and this has an impact on performance: the filters are installed individually, issues were opened\nlis: drafting a Virtual Machine Image API Specification (OEM strings, vsock, serial console, sd_notify, ssh, ephemeral keys, rootfs resize protocol, etc.) https://codeberg.org/lis/test.thing/src/branch/main/doc/VirtualMachineAPI.md Shared set of building blocks for distros and harnesses and test frameworks Ssh is available everywhere already and has tons of features and support (file transfer, “proper session”, port forwarding) Call it “profile 1” as it will cover 90% but there might be different ones in the future https://systemd.io/VM_INTERFACE/ Sd-notify sends systemd-specific string to send ready notification, what about non-systemd guests? Uapi-group or systemd.io? Former is more visible, but this has lot of systemd-specific concepts IMDS needs fully configured network, and then provides json over http for configuring VMs on first boot Use hwdb for cloud-specific configuration quirks Profile n. 2 for getting config over a well known port on vsock Thing in common is credentials as the way to specify configuration, independently from transport protocol Rename a bunch of credentials to use uapi-group.org instead of systemd.io\nand unify .boot. and .stub. Credentials? UEFI firmware and TPM sometimes behave in unexpected ways. It would be nice to have a common benchmark that is Linux focused. Or a database. Both with ubuntu and gnomeos weird bugs show up with tpm corner cases, especially with certain firmwares Eg: run fwupd security to check what is missing, pcrlock also can be ran Document that describes the minimal set of tools to run to verify that everything is green for a new hardware machine, for vendors Contact Richard Hughes (fwupd) about exposing required information based on hardware? Add spec to uapi-group, which then can link to various tools Should include other things like graphics Talking with Framework, if there was a framework (!) that was plugin based, it could be a common diagnostic collection solution First item to check in the test framework: load EFI image with more than 25 sections Some laptops don’t measure separator even when loading bootloader Check that firmware updates don’t reset the tpm Future work: have hwdb tags suggesting hardware support sysexts to load Build systems for OS images Flatcar uses custom image build system that creates a disk image w/ partitions, loopback-mounts individual partitions, emerges binaries into the mount point and cleans up portage metadata. Then unmounts and adds verity to the partition. Bootc-image-builder uses the OSBuild backend to build disk images from bootable containers Kiwi (used by SUSE) builds all kind of OS and container images OBS supports mkosi for UKIs and OS images, with secure boot and dm-verity signing OSBuild creates lvm-ready disk images by using random vg names, as lvm is not namespaced and the build system already runs on lvm Idea: “mock” lvm and create filesystems images and glue them together with the lvm-specific padding/header Build systems and sysexts: Flatcar sysext bakery Hosts on github releases, with a URL rewriter Nightly GH actions automates building updated sysexts when new upstream versions are released OBS can build and sign sysexts with mkosi GNOME OS uses systemd-repart in BuildStream to build and optionally sign sysexts In the CI sysext-utils is used Fedora Core OS has a build system on github actions How to split up root vs home partition space a/b/c vs something else, preallocation problem given limited disk space Homed: double encryption If partitioning is used at all, at install time you need to know exactly what the use case will be for the lifetime of the device Impossible to get right all the time for all users (or arguably impossible to ever get right at any time for any user..but you might get it wrong by a small enough amount to not be noticed) Adrian: Zero-cost layered encryption (https://github.com/orgs/uapi-group/discussions/96) Have you heard the good news about our lord and saviour composefs? boo! Btrfs! You mean ZFS? Btrfs on sparse volumes Needs fix in the kernel so that filesystems can know how much space they have available Btrfs can ask the thin layer for space when it needs it, and can take these volumes in account Loopback files inside btrfs (or some other writable fs or dm-thin), each loopback file is another instance of btrfs which can be encrypted Lower level brtfs is the partition table Could not be btrfs, could be new ‘dm-thin’ Usual blobfs option from fuchsia Christoph Hellwig proposed object storage, filesystem without files, inodes or everything, just objects that can be allocated, grown, shrunk and written to (NixOS) Ryan: built-in workload/node identity in systemd SPIFFE: attestation id given to systemd units Attestation is pluggable: can be done via something like AWS IMDS or TPM2 Local daemon attests that a service is actually that service, and attestation report can then be sent Service ID should be based on cgroup ID BPF-LSM to stop random processes to use the cgroup inodes and enforce delegation Pid1 on boot sets trusted xattr on itself and bpf lsm that stops any other process from setting the same xattr, and enforces delegation rules for cgroups For generic TPM stuff systemd can take care of it, for more specific use cases implement their own backends via varlink (NixOS) Niklas: How to do Measured Boot with TPM2 encryption with fully image based non-interactive systems? systemd-measure vs systemd-pcrlock, vendor vs. user (NixOS) Butz: .pcrsig covering more than PCR#11, e.g. PCR#4 through a UKI add-on? PCR11 obvious, PCR4 not TPM cannot bind policies to static PCRs as it’s too limited, even for simple VMs Pcrlock solves the consumer/interactive part, observes measurements on first boot, but also can take pcrlock files that can be pre-generated and placed in /usr/ Can provide pcrlock via nul-encrypted creds in the esp (to avoid chicken-and-egg problem) Updating the policy requires bringing the system in a ‘good state’, which implies rebooting, which is not great for desktops, but might be ok for other cases Move code from systemd-pcrlock to shared lib so systemd-measure can access it. Should be a simple change and likely easy to get merged. If the systems are really and completely predictable, pcrsig can be used, and provided via creds too, and it can cover any pcr, not just 11, pick it from the esp via tmpfiles.d In SUSE sdbootutil to deal with brtfs snapshots and measurements, auto triggered from package manager, rebuilds the policy Ubuntu Core uses PCR 4, 7, 12 (using custom code) Related: (NixOS) Butz: automatic/non-interactive migration from PolicyPCR to PolicyAuthorize/PolicyNV for e.g. PCR#7 You have to re-enroll Sysext services handling on merge/unmerge, service aware sysexts Users want to merge and unmerge exts at runtime, systemd has no awareness of actual content like tmpfiles or units and viceversa Flatcar would like services run from sysexts be aware of being run from a sysext so that it can clean up after itself when it is stopped during upgrade/upgraded Discussion why this is not being done via portable services Varlink! Either single or directory multiplexer in sysupdate for callouts on updates Sysex’d service ships a socket unit that receives a varlink message from sysupdate when it is being unmerged Lennart: Landlock lsm support Nice because unprivileged, nice design If it existed 10 years ago it would have been used for ReadOnlyPaths= and friends Very similar to existing things, but no perfect overlap Pending PR on systemd, WIP Uncertain future, few contributors Advantage is being able to do this without namespaces Nix interpreter planning adopting it for extra self-sandboxing, e.g. abstract domain sockets (LANDLOCK_SCOPE_ABSTRACT_UNIX_SOCKET) Does it fix mount propagation issues with ProtectSystem? Unclear Pacman uses it for self-sandboxing Used in GNOME’s localsearch to limit access to what it indexes And many more individual applications (NixOS) Ryan: systemd-update delta downloads / authentication methods / feedback. GNOME also needs this KDE Linux is currently using a stopgap solution inbetween sysupdate https://invent.kde.org/kde-linux/kde-linux-sysupdated Change importd to use a varlink callout instead of shelling to sd-pull so that it is pluggable Cutpoints between chunks in casync based on hashing, so best cut point often missed, many file formats have better well-known cut points, like GPT at partition start and end, maybe call out (VARLINK!) to analysis tool that can give a list of suggested offsets Documentation of the plan, to-be-implemented by GNOME folks with STF funding: https://github.com/systemd/systemd/issues/28227 https://github.com/systemd/systemd/issues/33351 You could look into using zstd as a patching engine: https://github.com/facebook/zstd/wiki/Zstandard-as-a-patching-engine Action Items# Start a hwdb for firmware where microsoft keys can be safely removed without bricking the machine (or actually, a tri-logic mapping: good, bad, and then the lack of key means “unknown”) "}]