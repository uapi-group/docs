<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.104.3"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Image-based Linux summit, 5th - 6th October 2022, Berlin # The first image-based Linux summit took place on the 5th and the 6th of October, 2022. It was conducted as a loosely structured BoF-style event. The following parties were present at the summit (in no particular order):
Distros / Entities: Ubuntu Core, Debian, GNOME OS, Fedora CoreOS, Endless OS, Arch Linux, SUSE, Flatcar, Microsoft, Amazon, Meta Projects: systemd, image-builder/osbuild, mkosi, tpm2-software, System Transparency, buildstream, BTRFS, rpm-ostree Actionables and tasks # Action items listed here can be found as TODO #[x] in the full meeting minutes below, with [x] being the action item number."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="Image-based Linux summit, 5th - 6th October 2022, Berlin # The first image-based Linux summit took place on the 5th and the 6th of October, 2022. It was conducted as a loosely structured BoF-style event. The following parties were present at the summit (in no particular order):
Distros / Entities: Ubuntu Core, Debian, GNOME OS, Fedora CoreOS, Endless OS, Arch Linux, SUSE, Flatcar, Microsoft, Amazon, Meta Projects: systemd, image-builder/osbuild, mkosi, tpm2-software, System Transparency, buildstream, BTRFS, rpm-ostree Actionables and tasks # Action items listed here can be found as TODO #[x] in the full meeting minutes below, with [x] being the action item number."><meta property="og:type" content="article"><meta property="og:url" content="https://uapi-group.org/docs/minutes/2022-10-05__image-based-linux-summit/"><meta property="article:section" content="minutes"><title>2022 10 05 Image Based Linux Summit | UAPI group generic documents and meeting minutes</title><link rel=manifest href=/docs/manifest.json><link rel=icon href=/docs/favicon.png type=image/x-icon><link rel=stylesheet href=/docs/book.min.f716a89e40b01f033146ee402497165ac5bcf8935948094dceafbcb19f6f3c8d.css integrity="sha256-9xaonkCwHwMxRu5AJJcWWsW8+JNZSAlNzq+8sZ9vPI0="><script defer src=/docs/en.search.min.c0ec46ff1d7ccffcc2aeafe741fbe85ee7916b8619972650a15b1f82f11ecd8f.js integrity="sha256-wOxG/x18z/zCrq/nQfvoXueRa4YZlyZQoVsfgvEezY8="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/docs><span>UAPI group generic documents and meeting minutes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://uapi-group.org/>⬅️ Back to top</a></li><li>⸻</li></ul><ul><li><span>Minutes</span><ul><li><a href=https://uapi-group.org/docs/minutes/2022-10-05__image-based-linux-summit/ class=active>2022 10 05 Image Based Linux Summit</a></li></ul></li></ul><ul><li>⸻</li><li><a href=https://github.com/uapi-group/docs target=_blank rel=noopener>Collaborate on Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/docs/svg/menu.svg class=book-icon alt=Menu></label>
<strong>2022 10 05 Image Based Linux Summit</strong>
<label for=toc-control><img src=/docs/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#actionables-and-tasks>Actionables and tasks</a></li><li><a href=#meeting-minutes>Meeting minutes</a><ul><li><a href=#os-images-and-integrity>OS images and integrity</a></li><li><a href=#handling-user-configuration-changes>Handling user configuration changes</a></li><li><a href=#updating-os-images-and-overlays>Updating OS Images and overlays</a></li><li><a href=#general-ab-booting-versioning>General A/B booting, versioning</a></li><li><a href=#tpm-provisioning-enrolling-measurement-remote-attestation>TPM provisioning, enrolling, measurement, remote attestation</a></li><li><a href=#os-factory-reset>OS factory reset</a></li><li><a href=#distributing-os-images>Distributing OS images</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=image-based-linux-summit-5th---6th-october-2022-berlin>Image-based Linux summit, 5th - 6th October 2022, Berlin
<a class=anchor href=#image-based-linux-summit-5th---6th-october-2022-berlin>#</a></h1><p>The first image-based Linux summit took place on the 5th and the 6th of October, 2022. It was conducted as a loosely structured BoF-style event.
The following parties were present at the summit (in no particular order):</p><ul><li>Distros / Entities: Ubuntu Core, Debian, GNOME OS, Fedora CoreOS, Endless OS, Arch Linux, SUSE, Flatcar, Microsoft, Amazon, Meta</li><li>Projects: systemd, image-builder/osbuild, mkosi, tpm2-software, System Transparency, buildstream, BTRFS, rpm-ostree</li></ul><h2 id=actionables-and-tasks>Actionables and tasks
<a class=anchor href=#actionables-and-tasks>#</a></h2><p>Action items listed here can be found as <strong>TODO #[x]</strong> in the full meeting minutes below, with [x] being the action item number.</p><ol><li>Provide feedback to the
<a href=https://github.com/systemd/systemd/issues/24864>proposal for <code>systemd-syscfg</code></a></li><li>Propose spec for application configuration file search path order to evangelise to application builders.
Extend xdg_base specification to specify order (first to last):<ul><li><code>/run</code> , then <code>/etc</code> , then <code>/usr/etc</code></li><li>use <code>/usr/share/factory</code> for vendor defaults, apps should never look there</li><li>Let users override the above, e.g. via env vars (e.g. add <code>/usr/local/…</code>)</li></ul></li><li>Extend UKI to support allow-list of kernel command line parameters, or env var-like file<ul><li>allow sd-stub to pick up new cmdline via files, make shim verify it (via MoK), and consume it</li></ul></li><li>Add support for UKI booting to Grub. E.g. Grub module that loads a UKI and jumps into the kernel.<ul><li>Grub already has PE parser</li><li><strong>4a. TODO sd-boot</strong>: Support type 1 entry that references type 2 + own kernel command line options</li></ul></li><li>Missing mkosi features:<ul><li>make sysext, UKI builds fully reproducible. calculate the signature server side, rebuild locally and apply (to make sig optional in case of legacy / non-UEFI system)</li><li>support iso9660 -
<a href=https://github.com/systemd/mkosi/issues/1220>tracked here</a>, also see <strong>TODO 10</strong></li><li>switch to systemd-repart for unprivileged image builds,
<a href=https://github.com/systemd/mkosi/issues/1228>tracked here</a></li><li>SPDX manifest file <strong>TODO 17</strong></li></ul></li><li>Extend Discoverable Partitions Specification to<ul><li>add policy language to restrict what the initrd will load from the disk</li><li>allow recovery partition GUID</li><li>allow discovery subvolumes/inode (BTRFS)</li></ul></li><li>Add versioning of resources to sysext / UKI spec. Use RPM versioning format. Auto-detect versioned resources by means of version prefix in sub-directories:<ul><li><code>./foo.a/</code> has image(s) for resource <em>foo</em> version <em>a</em> (with <em>a</em> following RPM versioning format)</li><li><code>./foo.b/</code> has image(s) for resource <em>foo</em> version <em>b</em></li></ul></li><li>(Flatcar team) Add support for <code>boot-complete.target</code> to signal &ldquo;healthy boot&rdquo;. Flatcar uses non-standard <code>update_engine.service</code> for the same.<ul><li>Tracked in
<a href=https://github.com/flatcar/Flatcar/issues/865>Flatcar #865</a></li></ul></li><li>Systemd <code>boot-complete.target</code>: add optional timer that fails if target is not reached within timeout, triggering a reboot, in turn triggering a rollback.</li><li>Support in <code>systemd-repart</code> for<ul><li>optionally removing outdated partitions to free up space.</li><li>MBR</li><li>iso9660 (will also address part of <strong>TODO 5</strong>)</li></ul></li><li>Systemd to provide / standardise on a common target that means, after this is reached, root fs has been resized/reparted/etc and it is fully writable and ready<ul><li><code>initrd-root-fs.target</code> already exists for the initrd stage</li><li><code>local-fs-pre.target</code> ? or new target?</li><li><a href=https://github.com/systemd/systemd/pull/24680>https://github.com/systemd/systemd/pull/24680</a></li></ul></li><li>Standardise UEFI environment for systemd-repart to trigger full / partial reset.<ul><li>Also define a systemd target to reboot into for factory reset (full or partial) for interactive / desktop systems to offer on a boot menu</li><li>Add support to repart for full repartitioning (full factory reset) if the disk UUID was set to <code>0xFFFF</code>… (similar to existing support for partition factory reset on UUID <code>00000</code>…)</li><li>To handle app config, add support to systemd-tempfiles for removing files in factory reset mode -
<a href=https://github.com/systemd/systemd/pull/24983>tracked here</a></li></ul></li><li>Discoverable Partition Spec: add specifications for partition flags to indicate the partition&rsquo;s purpose (e.g. boot, sysext, recovery, etc.)<ul><li>systemd-sysupdate would ignore recovery partitions and not consider these part of an A/B update scheme</li></ul></li><li>systemd-sysupdate, systemd boot: add protection against unwanted roll-back (downgrade attack) by use of TPM counters.</li><li>Add support for secure boot SBAT csv of images embedded in UKI, add SBAT csv to verity signature in DDI discover part<ul><li>mkinitcpio already implements objcopy functions which could be reused</li></ul></li><li>systemd-sysupdate download helper to become ‘pluggable’, so casync or other can be used instead of the built-in downloader (http).</li><li>Add SPDX/SBOM field in os-release that points to local file or URL <strong>TODO #17</strong></li><li>Enhance either cryptsetup or systemd-cryptsetup to support Shamir Secret Sharing and combine multiple tokens/slots</li></ol><h2 id=meeting-minutes>Meeting minutes
<a class=anchor href=#meeting-minutes>#</a></h2><h3 id=os-images-and-integrity>OS images and integrity
<a class=anchor href=#os-images-and-integrity>#</a></h3><ul><li><p>UKI (unified kernel image):
<a href=https://github.com/systemd/systemd/pull/24351>a new kernel/initrd format</a></p><ul><li>limited to 4GB to fit into EFI space</li><li>Secure, immutable, all in a single file (easy to update)</li><li>Baked-in initrd, cmdline, root credentials (signed list of TPM PCR 11 values, key that signs the list)</li><li>simplified storage of OS secrets, like disk encryption keys, making updates less brittle</li><li>Credentials stored in the ESP, together with the UKI, are also gathered and passed to the booted system</li><li>wrapped in a PE file, signed for UEFI Secure Boot</li><li>There is a Red Hat feature request to allow multiple kernel cmdline in a single UKI, bootloader generates menu based on that (eg: debug mode, safe mode, etc.)</li><li>Lack of bootloader-passed, custom command line could create issues later. <strong>TODO #3</strong> to fix this.</li></ul></li><li><p>Root fs: UKI cmdline can have verity roothash, credentials can extended that</p></li><li><p>UKIs enable both secure boot and TPM based security, independently</p></li><li><p>The TPM-based story for UKIs gives stronger guarantees than just Secure Boot, by allowing to express/attach policies to specific kernes/UKIs.</p></li><li><p>grub lacks support for UKI. <strong>TODO #4</strong> to fix that.</p><ul><li>would limit future flexibility in UKIs though (e.g. custom logic) since Grub would then need to support that, too</li></ul></li><li><p>Initrd is generated via mkosi</p><ul><li><a href=https://github.com/systemd/mkosi-initrd>https://github.com/systemd/mkosi-initrd</a></li><li><a href=https://lpc.events/event/16/contributions/1188/attachments/993/1949/lpc2022-new-design-for-initrds.pdf>LPC presentation slides</a><ul><li><a href="https://www.youtube.com/watch?v=rDPo5onf-Rc&t=11088s">LPC presentation recording</a></li></ul></li><li>Layered initrd, signed/read-only/measured, built server-side and deployed and loaded on demand</li><li>Base initrd in UKI works on most systems, is extendable via sysext (e.g. optional support for hardware)</li><li>mkosi-initrd can build base and layers from packages only</li><li>Some work is ongoing on dracut to support this, in a hybrid mode where it builds the initrd/extensions from dracut modules, but no dracut runtime logic on the running system<ul><li>Problem: size constraints for existing systems, that have to be supported</li></ul></li></ul></li><li><p>Documentation on pre-calculated and signed PCR values:</p><ul><li><a href=https://github.com/systemd/systemd/blob/main/man/systemd-measure.xml>Unrendered measure manpage, updated quickly</a></li><li><a href=https://www.freedesktop.org/software/systemd/man/systemd-measure.html>Rendered measure manpage, may be outdated</a></li><li><a href=https://github.com/systemd/systemd/blob/main/man/systemd-stub.xml>Unrendered stub manpage, updated quickly</a></li><li><a href=https://www.freedesktop.org/software/systemd/man/systemd-stub.html>Rendered stub manpage, may be outdated</a></li></ul></li><li><p>UKI might be proposed for Fedora 39</p><ul><li>Sysext initrd extensions will be shipped in RPMs</li><li>Sysext, UKI not fully reproducible, see <strong>TODO #5</strong></li></ul></li><li><p><a href=https://systemd.io/DISCOVERABLE_PARTITIONS/>Discoverable Partitions Specification</a></p><ul><li>Please file PRs to extend the specification to
<a href=https://github.com/systemd/systemd/blob/main/docs/DISCOVERABLE_PARTITIONS.md>systemd&rsquo;s repository</a></li><li>Input collected in Summit see <strong>TODO #6</strong></li><li>DDI: Discoverable Disk Image, uses DPS and signed dm-verity. Inspired by Canonical&rsquo;s Snaps, uses the same technique and builds on top of it.</li></ul></li><li><p>Distro-independent sysext images? Vision: Kubernetes project can publish their own Kubernetes sysext, runs well on all distros, is self-updating client side, so Kubernetes upstream can keep it up to date just by publishing new versions.</p><ul><li>Could be done by promoting building tools for Go/Rust static binaries. Flatcar has a lab / playground for this,
<a href=https://github.com/flatcar/sysext-bakery>for example for Docker</a>.</li></ul></li><li><p><code>mkosi</code> to build UKIs, DDIs etc.. python based</p><ul><li>configured via .ini plus drop-ins</li><li>supports dm-verity, SecureBoot, Signatures, PCR measurement</li></ul></li><li><p>for building UKIs, DDIs, sysext, initrd, OS images (w/ split partition support for individual partition update images)</p><ul><li>Produces manifest file with list of packages that were installed (SBOM)</li><li>Does not support SLSA</li><li>Native support on OBS
<a href=https://build.opensuse.org/project/show/home:bluca:mkosi>Open Build Service</a></li><li>Some features missing like reproducible builds, iso9660, switching to systemd-repart, see <strong>TODO 5</strong><ul><li>WIP: unprivileged builds, but dracut still needs root (run nspawn in image), BTRFS too</li><li>Fedora CoreOS uses a small VM to handle partitioning / fill partitions w/o privileges, circumventing the above</li></ul></li></ul></li><li><p>rpm-ostree + coreos-assembler can build images (kind-of-images as you can put them into a container image / convert to something else), see
<a href=https://github.com/coreos/rpm-ostree>https://github.com/coreos/rpm-ostree</a>,
<a href=https://github.com/coreos/coreos-assembler>https://github.com/coreos/coreos-assembler</a></p></li><li><p><a href=https://www.osbuild.org/>osbuild</a></p></li><li><p>Endless: OSTree built with eos-ostree-builder - private repo, but
<a href=https://github.com/dbnicholson/deb-ostree-builder>deb-ostree-builder</a> is similar – and GPT disk images with
<a href=https://github.com/endlessm/eos-image-builder>eos-image-builder</a></p></li><li><p>KIWI
<a href=https://github.com/OSInside/kiwi>https://github.com/OSInside/kiwi</a></p></li><li><p>Flatcar uses custom python script inherited from CoreOS, always builds images from sources (Gentoo style)</p><ul><li>Adds
<a href=https://www.flatcar.org/docs/latest/reference/supply-chain/>SLSA provenance</a> (sources fingerprints -> binaries fingerprints) to OS image during build.</li></ul></li><li><p>Need to standardize on a common target that means, after this is reached, root fs has been resized/reparted/etc and it is fully writable and ready - see <strong>TODO #11</strong></p></li><li><p>Novel Linux file system technology for immutable OS images (blobfs, …)</p><ul><li><a href=https://github.com/containers/composefs>composefs</a></li><li>RPM-backed images, e.g. using btrfs reflinks (rpm2extents) or FUSE (repomount)</li><li>Blobfs (
<a href=https://fuchsia.dev/fuchsia-src/concepts/filesystems/blobfs>Fuchsia</a>)<ul><li>simple FS that only allows git-like object store. Add object, get hash back</li><li>No Linux support</li><li>No inodes/filenames/dentries/attributes/access modes/timestamps/directories</li><li>verity-protected, de-duplicated by default, garbage collection</li><li>Simple enough to be accessed from firmware too</li></ul></li></ul></li><li><p>Would enable use of single partition instead of A/B, could be added to the bottom of GPT and grow at the front. Pool of images - DDIs/UKIs or anything else - available everywhere with implicit and automatic trust in that partition.</p></li></ul><h3 id=handling-user-configuration-changes>Handling user configuration changes
<a class=anchor href=#handling-user-configuration-changes>#</a></h3><ul><li><p>systemd already supports <code>/usr/share/factory/</code> and specifiers in tmpfiles.d to populate <code>/etc/</code> from there</p></li><li><p>Other projects (ostree, libeconf) populate from <code>/usr/etc/</code></p></li><li><p>Some other projects use a 3-way merge of configurations in <code>/etc/</code></p><ol><li>Previous version default config</li><li>Previous version w/ user changes</li><li>New version default config</li></ol></li><li><p>Merging of configurations? PAM as a negative example w/ single-line changes</p><ul><li>Red Hat works around this by abstracting PAM into features (coarse application support), Debian has a more fine-grained (but manual) merge tool.</li><li>PAM future: serve a static configuration and provide an API for dynamic / user defined changes</li></ul></li><li><p>PAM is just one example, glibc&rsquo;s nss-switch is another</p></li><li><p>OSTree copies from <code>/usr/etc/</code> to <code>/etc/</code> at first boot</p><ul><li>On update, new configs are copied, user changes remain untouched (== config merge in per-file granularity)</li></ul></li><li><p>OpenSUSE uses the
<a href=https://opensuse.github.io/libeconf/>libeconf</a> project, and MicroOS uses BTRFS snapshots: when a new snapshot is created, chroot into it and run the rpm scriptlets, then makes it read-only. User modifications are done via OverlayFS and stored in /var, which is outside the snapshot.</p></li><li><p>Programs could forward-convert config via ExecStartPre that figures out config differences semantically</p><ul><li>sshd has ssh-keygen for example</li><li>Not fully adopted on all distros for first boot generation</li><li>needs buy-in of each project to ship such tool</li></ul></li><li><p>User management: Fedora has started moving away from <code>/etc/passwd</code> and <code>/etc/group</code> to <code>systemd-sysusers</code></p></li><li><p>systemd project just published
<a href=https://github.com/systemd/systemd/issues/24864>syscfg proposal</a>, see <strong>TODO #1</strong></p><ul><li>Core concept is that even for configuration, one can always trace any file back to its source in a cryptographically secure way</li><li>Could systemd-syscfg look at configuration-release <code>SYSCFG_LEVEL=</code> and make sure it matches <code>/usr/</code>&rsquo;s <code>SYSCFG_LEVEL=</code>, and find the right image, or refuse a wrong one?</li><li>Add sliding window for version support, on top of `==``</li><li>systemd-repart will be able to build syscfg DDIs, should be multi-call (call as e.g. systemd-makesyscfg build config DDI)</li></ul></li><li><p>long term, systemd sysext aims to use <code>/etc/</code> as immutable / service factory default stack of configuration images and <code>/etc/local/</code> as local user modifications.</p><ul><li>distinguish between verified, secure config and binaries</li><li>make node state cryptographically deterministic and only deploy workloads if we can prove a node to run trusted binaries in a trusted configuration</li><li>tie a specific configuration to a specific time window, which allows e.g. a secret to be unlocked only in a given week and not afterwards</li></ul></li><li><p>syscfg rollback: how to do it at system level?</p><ul><li>At service level (<code>ConfigurationImages=</code>) it’s easier as there’s a single one that has a clear signal on reload</li><li>At system level problem is combinatorial explosion, could try with counters - each config image has a counter, start with highest and count down</li><li>Also needs rollback protection, idea: TPM2 monotonic counter establishes (sliding) range window of allowed versions</li></ul></li><li><p><strong>TODO #2</strong>: establish spec for search path order, to at least try to push applications, extend xdg_base specification to specify order as (first to last). See details there.</p><ul><li><code>/run/</code> -> <code>/etc/</code> -> <code>/usr/etc/</code>, <code>/usr/share/factory/</code> for vendor</li><li>mask, override, etc.</li></ul></li><li><p>OSTree uses <code>/usr/etc/</code> and <code>/etc/</code>, prefers local (<code>/etc/</code>) files in case of conflicts</p><ul><li>enforces reboots after config changes</li></ul></li><li><p>Some distros address this at packaging level, push package maintainers to default to <code>/usr/etc/</code></p><ul><li><a href=https://en.opensuse.org/openSUSE:Packaging_UsrEtc>UsrEtc on SUSE</a></li></ul></li><li><p>credential handling in <code>/etc/</code>: <code>systemd-credentials</code> can inject sensitive information into system services</p><ul><li>secrets are encrypted using TPMs, and only decrypted on demand immediately before consumption</li><li>meant as a replacement for passing creds in env variables</li><li>exposes secrets as files</li></ul></li></ul><h3 id=updating-os-images-and-overlays>Updating OS Images and overlays
<a class=anchor href=#updating-os-images-and-overlays>#</a></h3><h4 id=prior-art>Prior Art
<a class=anchor href=#prior-art>#</a></h4><ul><li>Build/deploy: can we learn from OCI?<ul><li>Current OCI users use tarballs and merge them, no offline/online security</li><li>OCI layers are linear and one way merge</li></ul></li><li>Fedora IoT / RHEL 4 Edge uses
<a href=https://github.com/fedora-iot/greenboot>Greenboot</a><ul><li>During meeting Greenboot was nudged to use boot-complete</li></ul></li><li>SUSE has openSUSE
<a href=https://github.com/openSUSE/health-checker>Health-checker</a></li><li>Ubuntu has a health check too</li><li>GNOME OS
<a href=https://gitlab.gnome.org/GNOME/gnome-build-meta/-/issues/560>nudge to use boot-complete</a></li><li>Endless OS has rudimentary check, &ldquo;did a user GNOME session start? If so, grub-editenv - unset recordfail&rdquo;)</li></ul><h4 id=future-developments>Future Developments
<a class=anchor href=#future-developments>#</a></h4><ul><li><p>systemd-repart: declarative configuration of system partitions, can populate systems with files too, cryptographically secure</p><ul><li>runs in initrd, &ldquo;magic tar for creating system layout&rdquo;</li><li>can build images, too (DDI - Discoverable Disk Image)</li><li>Supports GPT</li><li>Some features missing, see <strong>TODO #10</strong></li></ul></li><li><p>Automatic boot assessment after update to mark partition/disk/whatever as good/bad</p><ul><li><a href=https://systemd.io/AUTOMATIC_BOOT_ASSESSMENT/>Specification</a></li><li>Systemd provides <code>boot-complete.target</code> to signal &ldquo;boot is healthy&rdquo;<ul><li><strong>TODO #8</strong>: Add support to Flatcar</li></ul></li><li>Already hooked up with sd-boot</li><li>Make this target depend on health test / critical service units<ul><li>There is one test shipped by upstream that checks for no failed services, but is likely too broad as some services should be allowed to fail</li></ul></li><li><strong>TODO #9</strong>: add optional timer that fails if nothing happens within time, triggering reboot / rollback</li></ul></li></ul><h3 id=general-ab-booting-versioning>General A/B booting, versioning
<a class=anchor href=#general-ab-booting-versioning>#</a></h3><h4 id=prior-art-1>Prior Art
<a class=anchor href=#prior-art-1>#</a></h4><ul><li>grub vs. sd-boot<ul><li>legacy hardware / non-EFI</li><li>access to filesystems in grub</li><li>shim only supports grub (signature) as bootloader for secure boot currently<ul><li>Issue could be mitigated if grub could boot UKIs</li></ul></li></ul></li><li>Using partitions vs. putting fs images into writable space<ul><li>OS (initrd) would need to trust FS used for writable space</li><li>but since space is writable, FS exploits can be staged there, tainting the FS</li><li>OS, when booting, mounts tainted FS to get access to OS FS images stored there, and chain of trust is broken</li></ul></li><li>Chromebook/Android</li><li>Work in progress for (rpm-)ostree based systems to
<a href=https://github.com/containers/composefs>establish trust in the partition content</a></li><li>State of the &ldquo;custom/partial&rdquo;
<a href=https://fedoraproject.org/wiki/Changes/BootLoaderSpecByDefault>BLS support in Fedora</a></li><li>Support for fallback in Shim/grub<ul><li><a href=https://github.com/rhboot/shim/pull/502>Pull request</a></li><li>Used mostly for updating shim itself</li></ul></li><li>Non-EFI platforms?<ul><li>See <strong>TODO #4</strong> Grub UKI support</li></ul></li><li><a href=https://gitlab.com/evlaV/steamos-efi>SteamOS EFI loader</a><ul><li>Uses a &ldquo;A&rdquo; or &ldquo;B&rdquo; partition labels</li></ul></li><li><a href=https://github.com/rauc/rauc>RAUC</a><ul><li>Embedded updater, with A/B slots, integrates with many bootloaders/filesystems</li></ul></li></ul><h4 id=future-developments-1>Future Developments
<a class=anchor href=#future-developments-1>#</a></h4><ul><li>Concept: flag partition after booting, good/bad, fallback</li><li>sd-boot adds counters to UKI filename, uses counters for ordering in the menu for default entry</li><li>More generally, any resource (sysext or UKI) could be versioned with two counters<ul><li>e.g.: <code>nspawn --image=/path/some/directory/</code> picks the image from that directory based on counters</li><li>Version format is modified RPM version format</li><li>Directory suffix to signal that a directory organizes objects with this version specification inside. e.g.:<ul><li><code>./foo.a/</code> has image(s) for resource <em>foo</em> version <em>a</em> (with <em>a</em> following RPM versioning format)</li><li><code>./foo.b/</code> has image(s) for resource <em>foo</em> version <em>b</em></li></ul></li><li><strong>TODO #7</strong>: add to sysext spec</li></ul></li><li><strong>TODO #10</strong>: repart remove old / outdated partition that is not useful anymore<ul><li>Problem: usr/root partition is fixed after initial boot and repartition</li></ul></li></ul><h3 id=tpm-provisioning-enrolling-measurement-remote-attestation>TPM provisioning, enrolling, measurement, remote attestation
<a class=anchor href=#tpm-provisioning-enrolling-measurement-remote-attestation>#</a></h3><ul><li>Set up a Linux PCR registry, with a public list of which project claims which PCR, to allow vendor-independent coordination</li><li><a href=https://keylime.dev/>Keylime</a> is used in SUSE<ul><li>Measures using IMA hashes</li><li>Initrd measured twice</li></ul></li><li>Fedora CoreOS also looking into keylime for on boot remote attestation</li><li>DICE as a reference architecture<ul><li><a href=https://trustedcomputinggroup.org/wp-content/uploads/TCG_DICE_Attestation_Architecture_r22_02dec2020.pdf>TCG specification</a></li><li><a href=https://www.microsoft.com/en-us/research/project/dice-device-identifier-composition-engine/>Documentation from Microsoft</a></li></ul></li></ul><h3 id=os-factory-reset>OS factory reset
<a class=anchor href=#os-factory-reset>#</a></h3><h4 id=prior-art-2>Prior Art
<a class=anchor href=#prior-art-2>#</a></h4><ul><li>Fedora CoreOS has a
<a href=https://github.com/coreos/fedora-coreos-tracker/issues/399>WIP tracking issue to support factory reset</a></li><li>Endless OS currently just erases users & data, implemented as enabling a
<a href=https://github.com/endlessm/eos-boot-helper/tree/master/factory-reset>systemd service for next boot which disables itself once run</a></li><li>Flatcar uses a flag file in the ESP which is picked up and acted on by Ignition in the initrd, causing re-deployment of user config</li><li>Ubuntu core supports
<a href=https://ubuntu.com/core/docs/use-recovery-mode>reset via recovery partition (image file in ESP)</a></li><li>SUSE MicroOS keeps BTRFS snapshot #1 around, and it can be selected from cli or bootloader menu</li></ul><h4 id=future-developments-2>Future Developments
<a class=anchor href=#future-developments-2>#</a></h4><ul><li>Full reset vs. selectively keeping wanted local data<ul><li>Selective reset would allow reconfiguration for OSes which apply config at provisioning time (Flatcar, FCOS).</li><li>large downloads (e.g.container images, databases) would remain while config could be updated</li><li>benefit over using configuration management (Chef, Ansible) is that deployments remain idempotent, no config drift</li><li><strong>TODO #12</strong> has a sub-item to add support for removing files to systemd-tmpfiles to better support partial reset</li></ul></li><li>systemd-repart can mark a partition for factory reset, will re-initialise / clear those parts first, then continue boot<ul><li>Reset is triggered by an UEFI variable - in repart, but other systems use different ways (see below). <strong>TODO #12</strong> tracks standardising on reset.<ul><li>Also align on high-level target to reboot into, so desktops can provide menu to request factory reset</li><li>Repart also supports filling the partition if the UUID is set to 0000…</li><li>Add the same for 0xFFFFF to signal full factory reset (full repartitioning) for the disk GPT</li></ul></li></ul></li><li>How to restore factory config, and apps stored outside the OS image?<ul><li>Tmpfiles support for removing stuff only on factory reset mode -
<a href=https://github.com/systemd/systemd/pull/24983>tracked here</a></li></ul></li><li>Handling recovery partitions (Ubuntu core)<ul><li>Image could be updated but
<a href=https://ubuntu.com/tutorials/how-to-ubuntu-core-recovery-mode#1-overview>usually isn’t (security vs. robustness)</a></li><li><strong>TODO #13</strong> update Discoverable Partition Spec to define flags indicating purpose (boot, sysext, recovery). sysupdate would not consider recovery partitions in A/B update scheme.</li></ul></li></ul><h3 id=distributing-os-images>Distributing OS images
<a class=anchor href=#distributing-os-images>#</a></h3><h4 id=prior-art-3>Prior Art
<a class=anchor href=#prior-art-3>#</a></h4><ul><li><p>rpm-ostree builds OS images on the server side and distributes the resulting tree</p><ul><li>Optionally, a new layer can be built locally and overlaid on the base</li><li>When the base image is updated then the local build + overlay are repeated</li><li>Multiple transport channels are supported, e.g. static website (with static deltas, or individual object pulls, similar to Git). container registry</li><li>Initial installation uses image from (Live) ISO (w/ installer for automation), but image can also be <code>dd</code>ed to disk directly</li><li>3 release streams, user chooses which stream to follow</li></ul></li><li><p>Endless OS</p><ul><li>initial install is from GPT disk image <code>dd</code>ed to disk</li><li>updates are ostree images, composed server-side from debs. No local layering (like rpm-ostree does)</li><li>Transport channel is static HTTP</li><li>Clients fetch a delta from current revision, if available on server; otherwise, missing files are pulled individually</li></ul></li><li><p>Ubuntu core distributes a filesystem image that can be <code>dd</code>ed to disk</p><ul><li>Everything is shipped as snaps (in squashfs images)<ul><li>on boot, writable space contains 1 or more versions of base OS squashfs, &ldquo;current&rdquo; / &ldquo;good&rdquo; one is mounted on /.</li><li>Apps are snaps too, mounted similarly.</li></ul></li><li>Xdelta for image (snaps) updates</li><li>Transport channel is http with proprietary server side<ul><li>supports detached signatures based on hashes of snaps</li><li>Xdelta deals with squashfs mostly fine, deltas are created on-demand server-side</li></ul></li></ul></li><li><p>Flatcar: initial provisioning is full image, via cloud store / marketplace or manual download from image server (https). Image contains full partition layout; root partition is extended during provisioning to fill whole disk</p><ul><li>Flatcar updates are full images, no delta. Combined kernel+initrd+OS partition, all signed</li><li>Update from any version to any other.</li><li>Updates are orchestrated using the Omaha protocol, (Chrome OS update protocol)<ul><li>Omaha is a &ldquo;control plane&rdquo; layer on top of transports; clients poll for update</li><li>Allows controlled roll-out (only X clients at the same time)</li><li>Feedback channel from client to server, so server &ldquo;knows&rdquo; how many clients succeeded / failed. Roll-out can be stopped if too many clients fail</li><li>&ldquo;update succeeded&rdquo; uses &ldquo;boot succeeded&rdquo; semantics, i.e. user-defined system critical service units must start successfully, else update failed</li><li>Implemented in
<a href=https://github.com/kinvolk/nebraska>Nebraska server</a>, is FOSS</li></ul></li><li>Update transport channel is HTTPS, but Nebraska is transport agnostic and could serve any URIs</li><li>Flatcar offers 4 distinct channels: Alpha (developer), Beta (production-ready, for canaries) and Stable. LTS is a &ldquo;golden stable&rdquo; that receives only patch updates for 18 months.<ul><li>Patch releases go directly to each channel, new major releases are stabilised via Alpha -> Beta -> Stable transition</li></ul></li></ul></li></ul><h4 id=future-developments-3>Future Developments
<a class=anchor href=#future-developments-3>#</a></h4><ul><li><p>Systemd-sysupdate</p><ul><li>Is an updater for DDIs, but could also do directory trees. Command line tool to apply updates.</li><li>Information on how to update is inside the images themselves</li><li>Point sysupdate to the image, and it will be updated if needed (current version lower than image)</li><li>Built around lists of objects, version compared</li><li>Manifest of object store server-side as sha512 sums file</li><li>Compares version of what’s local, and what’s on the server, and gets right thing</li><li>Will be able to use casync as transport, which chunks an image (like zsync) into files (unlike zsync). Hence
<a href=http://zsync.moria.org.uk/>zsync</a> needs http range requests server-side,
<a href=https://github.com/systemd/casync>casync</a> does not.</li><li>Configurable chunk/block size; download size vs granularity trade-off left to owner/user</li><li>Giant pile of files (== individual chunks) on server, to be CDN-friendly</li><li>Always reconstruct target from seed, ideally could be used for backups (e.g.: homed)</li><li>Idea: create a TPM signed report which includes manifest for images, and also metadata about node itself (PSI etc), orchestrator collects these from nodes on a timer and produces credential that can only be decrypted by that specific node in that specific state</li><li>sysupdate transport is built-in (http) but should be pluggable - see <strong>TODO #16</strong></li></ul></li><li><p>TPM counters could be used to guard against unwanted rollbacks (downgrade attack).</p><ul><li>To still allow regular rollback,sliding window of allowed counter values could be used</li><li>Counters can only go up, need root to change. TPM can be reset by root, but lose all keys. Updating moves window forward.</li><li>Systemd at boot will bump counter, with graceful fallback in case counters do not work/not available</li><li>Vendors increase upper end on new release, increase lower end when cutting out older release</li><li>Signed PCR policy will include info about acceptable counters window</li><li>Client will be brought up to speed, as counter can be increased by any value</li><li>TPM monotonic counter support in tpm2-tools:
<a href=https://www.mankier.com/1/tpm2_nvincrement>https://www.mankier.com/1/tpm2_nvincrement</a></li><li>By spec, at least 3 counters per TPM, but nothing uses them anywhere</li><li>Does not allow multi-boot systems, as counters would not match</li><li>Tracked in <strong>TODO #14</strong> systemd to support rollback protection with counters</li></ul></li><li><p>Shim supports
<a href=https://github.com/rhboot/shim/blob/main/SBAT.md>Secure Boot Advanced Targeting (SBAT)</a>, stores counter in signed EFI variable, supports multiple vendors/distros.</p><ul><li>When booting a new version, old version can be marked as invalid, as EFI variables encode component names and minimum version</li><li>uses authenticated variables to store the policy (distro + version)</li><li>allows multi-boot systems, and cross-vendor/downstream distributions</li><li>sd-boot/sd-stub already embeds SBAT csv</li><li>initrd could be covered, too, with additional optional SBAT entries</li><li><strong>TODO #15</strong> add support for SBAT of inner UKI images (initrd), add SBAT to verity signature JSON in DDI, if kernel includes SBAT either sd-boot needs to check it through shim, or combined them in the outer UKI SBAT</li></ul></li><li><p>SBOM</p><ul><li>mkosi builds and publishes manifest file in custom JSON</li><li>Flatcar has an SPDX SBOM, a JSON file with version/license info, now it also added
<a href=https://flatcar-linux.org/docs/latest/reference/supply-chain/>SLSA provenance</a></li><li><a href=https://documentation.suse.com/sbp/server-linux/html/SBP-SLSA4/index.html>SUSE</a></li><li><a href=https://spdx.dev/>SPDX</a> and CyclonDX to build a standard manifest file</li><li>provenance/tracking<ul><li><a href=https://github.com/hughsie/python-uswid>uswid</a></li><li><a href=https://datatracker.ietf.org/doc/draft-ietf-sacm-coswid/>coswid</a></li><li><a href=https://slsa.dev/provenance/v0.1>slsa</a></li></ul></li><li><strong>TODO #17</strong>: add SPDX support to mkosi,
<a href=https://github.com/systemd/mkosi/issues/1230>tracked here</a></li><li><strong>TODO #17</strong>: add SPDX field to extension-release/os-release
SPDX=<url> or SPDX=<path> for self-contained DDI</li></ul></li><li><p>Live updates for kernel and userspace w/o downtime</p><ul><li>&ldquo;rocket surgery&rdquo;, many pitfalls</li><li>driver states / network queues etc. a problem, needs 100% control over hardware<ul><li>some HW state like TPM measurements are not resettable</li></ul></li><li>kexec can handle kernel w/o downtime, and w/o impacting user space</li><li>CRIU to update userland? Start userland in a VM and then move userland processes using CRIU</li><li>But what state CRIU migrates is opt-in, all things to carry over need to be specified explicitly</li><li>systemd-suspend uses freezer cgroup to stop everything except pid1<ul><li>But needs to re-arrange cgroup tree, which might break things</li></ul></li><li>systemd interested in hierarchical model of freezing, in which states can be passed up<ul><li>extend File Descriptor store so that state is persisted across kexec too (opt-in), using persistent memory, so that for a service a restart of the service or a kexec are the same</li></ul></li><li>userspace &ldquo;reboot&rdquo; (possibly with an &ldquo;exitrd&rdquo;, which is different from &ldquo;initrd&rdquo;, and resets some kernel state like <code>/dev/</code>), shut down everything and re-initialise to <code>default.target</code>, after switching to new root/usr DDI<ul><li>But need to figure out how to deal with TPM secrets that are phase-specific, but not different from kexec</li><li>Could stop measuring after the &ldquo;first&rdquo; boot phases</li></ul></li></ul></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/uapi-group/docs/edit/main/minutes/2022-10-05__Image-based-linux-summit.md target=_blank rel=noopener><img src=/docs/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#actionables-and-tasks>Actionables and tasks</a></li><li><a href=#meeting-minutes>Meeting minutes</a><ul><li><a href=#os-images-and-integrity>OS images and integrity</a></li><li><a href=#handling-user-configuration-changes>Handling user configuration changes</a></li><li><a href=#updating-os-images-and-overlays>Updating OS Images and overlays</a></li><li><a href=#general-ab-booting-versioning>General A/B booting, versioning</a></li><li><a href=#tpm-provisioning-enrolling-measurement-remote-attestation>TPM provisioning, enrolling, measurement, remote attestation</a></li><li><a href=#os-factory-reset>OS factory reset</a></li><li><a href=#distributing-os-images>Distributing OS images</a></li></ul></li></ul></nav></div></aside></main></body></html>